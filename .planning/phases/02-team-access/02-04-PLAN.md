---
phase: 02-team-access
plan: 04
type: execute
wave: 1
depends_on: []
files_modified:
  - src/features/teams/teams.routes.ts
  - src/features/projects/projects.routes.ts
  - src/features/roles/roles.routes.ts
  - src/features/teams/teams.service.ts
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "All data queries respect visibility rules (squad-scoped by default, cross-squad by grant)"
    - "Restricted users cannot see squads outside their visibility scope"
    - "Admin/PM users see all squads in their projects"
  artifacts:
    - path: "src/features/teams/teams.routes.ts"
      provides: "Visibility middleware applied to all squad routes"
      contains: "visibilityMiddleware"
    - path: "src/features/projects/projects.routes.ts"
      provides: "Visibility middleware applied to project routes"
      contains: "visibilityMiddleware"
    - path: "src/features/roles/roles.routes.ts"
      provides: "Visibility middleware applied to role routes"
      contains: "visibilityMiddleware"
    - path: "src/features/teams/teams.service.ts"
      provides: "Squad queries filtered by visibleSquadIds"
      contains: "visibleSquadIds"
  key_links:
    - from: "teams.routes.ts"
      to: "visibility.middleware.ts"
      via: "middleware chain"
      pattern: "visibilityMiddleware"
    - from: "teams.routes.ts"
      to: "teams.service.ts"
      via: "passing visibleSquadIds from context"
      pattern: "c\\.get\\('visibleSquadIds'\\)"
---

<objective>
Apply visibility middleware to data query routes and filter service queries by visibleSquadIds.

Purpose: Close VISB-05 gap - visibility rules exist but are not enforced on data routes
Output: Routes use visibilityMiddleware, service queries respect visibility scope
</objective>

<execution_context>
@/Users/dio/.claude/get-shit-done/workflows/execute-plan.md
@/Users/dio/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-team-access/02-03-SUMMARY.md

Key existing code:
- src/features/visibility/visibility.middleware.ts - exports visibilityMiddleware, sets c.get('visibleSquadIds')
- src/features/visibility/visibility.service.ts - computeVisibleSquads returns [] for admin/PM (all visible), array for restricted users
- Decision: Empty visibleSquadIds array means "all visible" for admin/PM/unrestricted users
</context>

<tasks>

<task type="auto">
  <name>Task 1: Apply visibilityMiddleware to route files</name>
  <files>
    src/features/teams/teams.routes.ts
    src/features/projects/projects.routes.ts
    src/features/roles/roles.routes.ts
  </files>
  <action>
    Add visibilityMiddleware import and apply it after authMiddleware in each route file:

    **teams.routes.ts:**
    - Add import: `import { visibilityMiddleware } from '../visibility/visibility.middleware';`
    - After line 36 (`teams.use('*', authMiddleware);`), add: `teams.use('*', visibilityMiddleware);`

    **projects.routes.ts:**
    - Add import: `import { visibilityMiddleware } from '../visibility/visibility.middleware';`
    - Change per-route middleware to global pattern:
      - Add after line 8 (const projects = new Hono()): `projects.use('*', authMiddleware);` and `projects.use('*', visibilityMiddleware);`
      - Remove individual `authMiddleware` from each route handler

    **roles.routes.ts:**
    - Add import: `import { visibilityMiddleware } from '../visibility/visibility.middleware';`
    - After line 17 (`roles.use('*', authMiddleware);`), add: `roles.use('*', visibilityMiddleware);`
  </action>
  <verify>
    `bun run typecheck` passes - no import errors
    `bun run lint` passes - no linting errors
  </verify>
  <done>
    All three route files import and apply visibilityMiddleware after authMiddleware
  </done>
</task>

<task type="auto">
  <name>Task 2: Update teams.service.ts to filter by visibleSquadIds</name>
  <files>
    src/features/teams/teams.service.ts
    src/features/teams/teams.routes.ts
  </files>
  <action>
    Update getSquadHierarchy to accept optional visibleSquadIds parameter and filter results:

    **teams.service.ts - getSquadHierarchy function:**
    - Change signature: `export async function getSquadHierarchy(projectId: string, visibleSquadIds?: string[]): Promise<SquadWithHierarchy[]>`
    - After fetching allSquads (line 104-106), add filtering logic:
      ```typescript
      // Filter by visibility if visibleSquadIds is provided and non-empty
      // Empty array means "all visible" (admin/PM/unrestricted)
      let filteredSquads = allSquads;
      if (visibleSquadIds && visibleSquadIds.length > 0) {
        filteredSquads = allSquads.filter(s => visibleSquadIds.includes(s.id));
      }
      ```
    - Use `filteredSquads` instead of `allSquads` for the rest of the function

    **teams.routes.ts - GET /projects/:projectId/squads:**
    - Update to pass visibleSquadIds from context:
      ```typescript
      teams.get('/projects/:projectId/squads', async (c) => {
        const projectId = c.req.param('projectId');
        const visibleSquadIds = c.get('visibleSquadIds');
        const hierarchy = await getSquadHierarchy(projectId, visibleSquadIds);
        return c.json(hierarchy);
      });
      ```

    **teams.routes.ts - GET /:id (single squad):**
    - Add visibility check before returning squad:
      ```typescript
      const visibleSquadIds = c.get('visibleSquadIds');
      // If visibleSquadIds is non-empty array, user is restricted - check access
      if (visibleSquadIds && visibleSquadIds.length > 0 && !visibleSquadIds.includes(id)) {
        return c.json({
          type: 'https://blockbot.dev/errors/squads/access-denied',
          title: 'Access Denied',
          status: 403,
          detail: 'You do not have visibility access to this squad',
          instance: c.req.path,
        }, 403);
      }
      ```

    **teams.routes.ts - GET /:id/members:**
    - Add same visibility check pattern as GET /:id
  </action>
  <verify>
    `bun run typecheck` passes
    `bun run test:unit` passes (if tests exist)
  </verify>
  <done>
    - getSquadHierarchy accepts visibleSquadIds and filters results
    - Squad routes check visibility before returning data
    - Empty visibleSquadIds array allows all access (admin/PM behavior preserved)
  </done>
</task>

</tasks>

<verification>
Run the following to verify the gap is closed:

```bash
# Type checking
bun run typecheck

# Linting
bun run lint

# Unit tests
bun run test:unit

# Verify middleware is applied (grep check)
grep -l "visibilityMiddleware" src/features/teams/teams.routes.ts src/features/projects/projects.routes.ts src/features/roles/roles.routes.ts

# Verify service accepts visibleSquadIds
grep "visibleSquadIds" src/features/teams/teams.service.ts
```
</verification>

<success_criteria>
1. All three route files (teams, projects, roles) apply visibilityMiddleware after authMiddleware
2. getSquadHierarchy filters results when visibleSquadIds is non-empty array
3. Single squad GET checks visibility before returning
4. Empty visibleSquadIds (admin/PM/unrestricted) sees all data
5. All existing tests continue to pass
6. TypeScript compiles without errors
</success_criteria>

<output>
After completion, create `.planning/phases/02-team-access/02-04-SUMMARY.md`
</output>
