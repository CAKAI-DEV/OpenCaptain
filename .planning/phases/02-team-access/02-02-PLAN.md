---
phase: 02-team-access
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - src/shared/db/schema/project-members.ts
  - src/shared/db/schema/squads.ts
  - src/shared/db/schema/squad-members.ts
  - src/shared/db/schema/index.ts
  - src/shared/lib/permissions/roles.ts
  - src/features/teams/teams.service.ts
  - src/features/teams/teams.routes.ts
  - src/features/teams/teams.types.ts
  - src/features/teams/index.ts
  - src/features/roles/roles.service.ts
  - src/features/roles/roles.routes.ts
  - src/features/roles/roles.types.ts
  - src/features/roles/index.ts
  - src/index.ts
autonomous: true

must_haves:
  truths:
    - "Admin can assign users to projects with specific roles"
    - "Admin can create squads and assign squad leads"
    - "Users can hold multiple roles across different projects"
    - "Squads can have one level of sub-squad nesting"
    - "Squad leads can view their squad members"
  artifacts:
    - path: "src/shared/db/schema/project-members.ts"
      provides: "User-project-role junction table"
      contains: "unique().on(table.projectId, table.userId)"
    - path: "src/shared/db/schema/squads.ts"
      provides: "Squad definitions with parent reference"
      contains: "parentSquadId"
    - path: "src/shared/db/schema/squad-members.ts"
      provides: "User-squad membership"
      contains: "squadId"
    - path: "src/shared/lib/permissions/roles.ts"
      provides: "Predefined role definitions with tiers"
      exports: ["PREDEFINED_ROLES", "CAPABILITIES"]
    - path: "src/features/teams/teams.service.ts"
      provides: "Squad CRUD with nesting limit enforcement"
      exports: ["createSquad", "getSquadHierarchy"]
  key_links:
    - from: "src/features/teams/teams.service.ts"
      to: "src/shared/db/schema/squads.ts"
      via: "Drizzle queries"
      pattern: "db\\.query\\.squads|db\\.insert\\(.*squads"
    - from: "src/features/roles/roles.service.ts"
      to: "src/shared/db/schema/project-members.ts"
      via: "Role assignment"
      pattern: "db\\.insert\\(.*projectMembers"
---

<objective>
Create role hierarchy system and squad management with membership tracking.

Purpose: Enable admins to create role blocks with hierarchical reporting (TEAM-03, TEAM-04), assign users to projects with roles (TEAM-02), create squads with leads (TEAM-06), and allow users to hold multiple project roles (TEAM-05).

Output: Working role assignment, squad CRUD, and membership endpoints with hierarchy enforcement.
</objective>

<execution_context>
@/Users/dio/.claude/get-shit-done/workflows/execute-plan.md
@/Users/dio/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-team-access/02-RESEARCH.md
@.planning/phases/02-team-access/02-CONTEXT.md
@.planning/phases/01-core-infrastructure/01-02-SUMMARY.md
@src/shared/db/schema/organizations.ts
@src/shared/db/schema/users.ts
@src/features/auth/auth.middleware.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create membership and squad schemas</name>
  <files>
    src/shared/db/schema/project-members.ts
    src/shared/db/schema/squads.ts
    src/shared/db/schema/squad-members.ts
    src/shared/db/schema/index.ts
    src/shared/lib/permissions/roles.ts
  </files>
  <action>
Create database schemas and role definitions:

**project-members.ts:**
```typescript
import { pgTable, uuid, varchar, timestamp, unique } from 'drizzle-orm/pg-core';
import { users } from './users';
import { projects } from './projects';

export const projectMembers = pgTable('project_members', {
  id: uuid('id').primaryKey().defaultRandom(),
  projectId: uuid('project_id').notNull().references(() => projects.id, { onDelete: 'cascade' }),
  userId: uuid('user_id').notNull().references(() => users.id, { onDelete: 'cascade' }),
  role: varchar('role', { length: 50 }).notNull(), // 'admin', 'pm', 'squad_lead', 'member'
  reportsToUserId: uuid('reports_to_user_id').references(() => users.id), // Optional override
  createdAt: timestamp('created_at', { withTimezone: true }).defaultNow().notNull(),
  updatedAt: timestamp('updated_at', { withTimezone: true }).defaultNow().notNull(),
}, (table) => ({
  uniqueUserProject: unique().on(table.projectId, table.userId),
}));
```

**squads.ts:**
```typescript
import { pgTable, uuid, varchar, timestamp, type AnyPgColumn } from 'drizzle-orm/pg-core';
import { projects } from './projects';
import { users } from './users';

export const squads = pgTable('squads', {
  id: uuid('id').primaryKey().defaultRandom(),
  projectId: uuid('project_id').notNull().references(() => projects.id, { onDelete: 'cascade' }),
  name: varchar('name', { length: 255 }).notNull(),
  parentSquadId: uuid('parent_squad_id').references((): AnyPgColumn => squads.id, { onDelete: 'cascade' }),
  leadUserId: uuid('lead_user_id').references(() => users.id),
  createdAt: timestamp('created_at', { withTimezone: true }).defaultNow().notNull(),
  updatedAt: timestamp('updated_at', { withTimezone: true }).defaultNow().notNull(),
});
```

**squad-members.ts:**
```typescript
import { pgTable, uuid, timestamp, unique } from 'drizzle-orm/pg-core';
import { squads } from './squads';
import { users } from './users';

export const squadMembers = pgTable('squad_members', {
  id: uuid('id').primaryKey().defaultRandom(),
  squadId: uuid('squad_id').notNull().references(() => squads.id, { onDelete: 'cascade' }),
  userId: uuid('user_id').notNull().references(() => users.id, { onDelete: 'cascade' }),
  createdAt: timestamp('created_at', { withTimezone: true }).defaultNow().notNull(),
}, (table) => ({
  uniqueSquadUser: unique().on(table.squadId, table.userId),
}));
```

**src/shared/lib/permissions/roles.ts:**
```typescript
export const PREDEFINED_ROLES = {
  admin: { tier: 0, name: 'Admin', capabilities: ['manage_org', 'manage_users', 'manage_projects', 'view_all'] },
  pm: { tier: 1, name: 'Project Manager', capabilities: ['manage_project', 'manage_squads', 'view_all', 'grant_visibility'] },
  squad_lead: { tier: 2, name: 'Squad Lead', capabilities: ['manage_squad', 'view_squad', 'assign_work'] },
  member: { tier: 3, name: 'Member', capabilities: ['view_own', 'update_own_work'] },
} as const;

export type RoleId = keyof typeof PREDEFINED_ROLES;

export const CAPABILITIES = {
  manage_org: 'Manage organization settings and users',
  manage_users: 'Invite and remove users',
  manage_projects: 'Create and configure projects',
  manage_project: 'Manage a specific project',
  manage_squads: 'Create and configure squads',
  manage_squad: 'Manage own squad members',
  view_all: 'View all project data',
  view_squad: 'View own squad data',
  view_own: 'View own work items',
  grant_visibility: 'Grant cross-squad visibility',
  assign_work: 'Assign work to squad members',
  update_own_work: 'Update own work items',
} as const;

export function getRoleTier(role: string): number {
  return PREDEFINED_ROLES[role as RoleId]?.tier ?? 999;
}

export function hasCapability(role: string, capability: string): boolean {
  const roleDef = PREDEFINED_ROLES[role as RoleId];
  return roleDef?.capabilities.includes(capability as any) ?? false;
}
```

Update src/shared/db/schema/index.ts to export new schemas.

Run migrations: `bun run db:generate && bun run db:migrate`
  </action>
  <verify>
`bun run db:migrate` succeeds.
`psql $DATABASE_URL -c "\dt"` shows project_members, squads, squad_members tables.
`bun run typecheck` passes.
  </verify>
  <done>
Project membership, squad, and squad membership tables created with proper constraints. Role definitions exported with tier and capability system.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create teams service with squad hierarchy</name>
  <files>
    src/features/teams/teams.types.ts
    src/features/teams/teams.service.ts
    src/features/teams/teams.routes.ts
    src/features/teams/index.ts
  </files>
  <action>
Create src/features/teams/ directory:

**teams.types.ts:**
```typescript
export interface CreateSquadInput {
  projectId: string;
  name: string;
  parentSquadId?: string;
  leadUserId?: string;
}

export interface AddSquadMemberInput {
  squadId: string;
  userId: string;
}

export interface SquadWithHierarchy {
  id: string;
  name: string;
  leadUserId: string | null;
  subSquads: SquadWithHierarchy[];
  members: { userId: string; createdAt: Date }[];
}
```

**teams.service.ts:**
- createSquad(input: CreateSquadInput):
  - If parentSquadId provided, verify parent exists and has NO parent itself (enforce 1-level limit)
  - Throw ApiError 400 'squads/nesting-limit' if trying to create sub-sub-squad
  - Insert into squads table
  - Return created squad

- getSquadHierarchy(projectId: string):
  - Single query for all squads in project
  - Build hierarchy in memory (efficient for 1-level max)
  - Return top-level squads with subSquads array

- getSquad(squadId: string):
  - Get single squad with lead info

- updateSquad(squadId: string, updates: Partial<CreateSquadInput>):
  - Update name, leadUserId
  - Cannot change projectId or parentSquadId

- deleteSquad(squadId: string):
  - Delete squad (cascades to members via FK)

- addSquadMember(input: AddSquadMemberInput):
  - Insert into squad_members
  - Return membership record

- removeSquadMember(squadId: string, userId: string):
  - Delete from squad_members

- getSquadMembers(squadId: string):
  - Return all members with user details

**teams.routes.ts:**
Create Hono router:
- POST /api/v1/squads - Create squad (auth required, must be admin/pm)
- GET /api/v1/projects/:projectId/squads - Get squad hierarchy for project
- GET /api/v1/squads/:id - Get single squad
- PATCH /api/v1/squads/:id - Update squad
- DELETE /api/v1/squads/:id - Delete squad
- POST /api/v1/squads/:id/members - Add member
- DELETE /api/v1/squads/:id/members/:userId - Remove member
- GET /api/v1/squads/:id/members - List members

Use Zod validation. Auth middleware required on all routes.

**teams/index.ts:** Export routes, service, types.
  </action>
  <verify>
`bun run typecheck` passes.
`bun run dev` starts.

Test with curl:
1. Create a squad in a project
2. Try to create a sub-squad (should work)
3. Try to create a sub-sub-squad (should fail with 400)
4. Add a member to squad
5. Get squad hierarchy
  </verify>
  <done>
Squad CRUD works with 1-level nesting enforcement. Members can be added and listed.
  </done>
</task>

<task type="auto">
  <name>Task 3: Create roles service with project assignment</name>
  <files>
    src/features/roles/roles.types.ts
    src/features/roles/roles.service.ts
    src/features/roles/roles.routes.ts
    src/features/roles/index.ts
    src/index.ts
  </files>
  <action>
Create src/features/roles/ directory:

**roles.types.ts:**
```typescript
export interface AssignRoleInput {
  projectId: string;
  userId: string;
  role: string;
  reportsToUserId?: string;
}

export interface ProjectMemberWithUser {
  id: string;
  projectId: string;
  userId: string;
  role: string;
  reportsToUserId: string | null;
  user: {
    id: string;
    email: string;
  };
}
```

**roles.service.ts:**
- assignRole(input: AssignRoleInput):
  - Validate role is in PREDEFINED_ROLES
  - Upsert into project_members (update if exists, insert if not)
  - If reportsToUserId not provided, compute default from role tier hierarchy
  - Return membership record

- removeFromProject(projectId: string, userId: string):
  - Delete from project_members

- getProjectMembers(projectId: string):
  - Return all members with user details and role info

- getUserRoles(userId: string):
  - Return all project memberships for a user (proves multi-role support)

- getDefaultReportsTo(projectId: string, role: string):
  - Find lowest-tier user above this role in the project
  - Used for automatic reporting hierarchy

**roles.routes.ts:**
Create Hono router:
- POST /api/v1/projects/:projectId/members - Assign role to user
- DELETE /api/v1/projects/:projectId/members/:userId - Remove from project
- GET /api/v1/projects/:projectId/members - List project members
- GET /api/v1/users/:userId/roles - Get user's roles across projects

Use Zod validation. Auth middleware required.

**roles/index.ts:** Export routes, service, types.

**src/index.ts:** Mount teams and roles routes.
  </action>
  <verify>
`bun run typecheck` passes.
`bun run lint` passes.

Test with curl:
1. Create a project (from 02-01)
2. Assign user as PM on project
3. Assign same user as member on different project
4. GET /api/v1/users/:userId/roles shows both roles
5. GET /api/v1/projects/:projectId/members shows assigned user
  </verify>
  <done>
Role assignment works. Users can have different roles per project. Default reporting hierarchy computed from role tiers.
  </done>
</task>

</tasks>

<verification>
1. All new tables exist: project_members, squads, squad_members
2. TypeScript compiles: `bun run typecheck` passes
3. Linting passes: `bun run lint` has no errors
4. Server starts: `bun run dev` runs without errors
5. Squad nesting limit enforced: Creating sub-sub-squad returns 400
6. Multi-role works: Same user can be PM on project A, member on project B
7. Role hierarchy: Assigning 'member' role auto-computes reportsTo based on tier
</verification>

<success_criteria>
- Admin can create squads with optional leads (POST /api/v1/squads returns 201)
- Squad nesting limited to 1 level (sub-sub-squad creation returns 400)
- Admin can assign roles to project members (POST /projects/:id/members returns 201)
- Users can hold different roles per project (GET /users/:id/roles shows multiple)
- Squad leads appear in squad response (lead_user_id populated)
- Predefined roles have correct tier hierarchy (admin=0, pm=1, squad_lead=2, member=3)
</success_criteria>

<output>
After completion, create `.planning/phases/02-team-access/02-02-SUMMARY.md`
</output>
