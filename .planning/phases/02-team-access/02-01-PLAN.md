---
phase: 02-team-access
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/shared/db/schema/projects.ts
  - src/shared/db/schema/invitations.ts
  - src/shared/db/schema/invite-links.ts
  - src/shared/db/schema/index.ts
  - src/features/invitations/invitations.service.ts
  - src/features/invitations/invitations.routes.ts
  - src/features/invitations/invitations.email.ts
  - src/features/invitations/invitations.types.ts
  - src/features/invitations/index.ts
  - src/features/projects/projects.service.ts
  - src/features/projects/projects.routes.ts
  - src/features/projects/projects.types.ts
  - src/features/projects/index.ts
  - src/index.ts
  - src/shared/lib/env.ts
autonomous: true

must_haves:
  truths:
    - "Admin can invite users to organization via email"
    - "Admin can create shareable invite links with 7-day expiry"
    - "User can accept invitation and join organization"
    - "Existing users receiving invites are auto-added with notification"
  artifacts:
    - path: "src/shared/db/schema/projects.ts"
      provides: "Projects table for project-scoped work"
      contains: "pgTable('projects'"
    - path: "src/shared/db/schema/invitations.ts"
      provides: "Email invitations with hashed tokens"
      contains: "tokenHash"
    - path: "src/shared/db/schema/invite-links.ts"
      provides: "Shareable invite links"
      contains: "usageCount"
    - path: "src/features/invitations/invitations.service.ts"
      provides: "Invitation creation and acceptance logic"
      exports: ["createEmailInvitation", "createShareableLink", "acceptInvitation"]
    - path: "src/features/invitations/invitations.routes.ts"
      provides: "POST /invitations, POST /invite-links, POST /invitations/accept"
      min_lines: 50
  key_links:
    - from: "src/features/invitations/invitations.routes.ts"
      to: "src/features/invitations/invitations.service.ts"
      via: "service function calls"
      pattern: "createEmailInvitation|createShareableLink|acceptInvitation"
    - from: "src/features/invitations/invitations.service.ts"
      to: "src/shared/db/schema/invitations.ts"
      via: "Drizzle insert/query"
      pattern: "db\\.insert\\(.*invitations|db\\.query\\.invitations"
---

<objective>
Create the projects schema and invitation system for organization user management.

Purpose: Enable admins to invite users to their organization via email or shareable links, supporting TEAM-01 requirement. Projects table provides the foundation for project-scoped roles in subsequent plans.

Output: Working invitation endpoints (email + shareable links), accept flow, auto-add for existing users.
</objective>

<execution_context>
@/Users/dio/.claude/get-shit-done/workflows/execute-plan.md
@/Users/dio/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-team-access/02-RESEARCH.md
@.planning/phases/02-team-access/02-CONTEXT.md
@.planning/phases/01-core-infrastructure/01-01-SUMMARY.md
@.planning/phases/01-core-infrastructure/01-02-SUMMARY.md
@src/shared/db/schema/organizations.ts
@src/shared/db/schema/users.ts
@src/shared/middleware/error-handler.ts
@src/features/auth/auth.middleware.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create projects and invitations schemas</name>
  <files>
    src/shared/db/schema/projects.ts
    src/shared/db/schema/invitations.ts
    src/shared/db/schema/invite-links.ts
    src/shared/db/schema/index.ts
  </files>
  <action>
Create database schemas following existing patterns in src/shared/db/schema/:

**projects.ts:**
- id (uuid, primary key, defaultRandom)
- orgId (uuid, FK to organizations.id, onDelete cascade)
- name (varchar 255, not null)
- description (text, nullable)
- createdAt, updatedAt (timestamp with timezone)

**invitations.ts:**
- id (uuid, primary key, defaultRandom)
- orgId (uuid, FK to organizations.id, onDelete cascade)
- email (varchar 255, not null)
- tokenHash (varchar 255, not null) - store hashed token, NOT plaintext
- role (varchar 50, nullable) - optional pre-assigned role
- invitedById (uuid, FK to users.id, nullable)
- expiresAt (timestamp with timezone, not null)
- acceptedAt (timestamp with timezone, nullable)
- createdAt (timestamp with timezone)

**invite-links.ts:**
- id (uuid, primary key, defaultRandom)
- orgId (uuid, FK to organizations.id, onDelete cascade)
- tokenHash (varchar 255, not null, unique)
- role (varchar 50, nullable)
- createdById (uuid, FK to users.id, nullable)
- expiresAt (timestamp with timezone, not null)
- usageCount (integer, default 0, not null)
- createdAt (timestamp with timezone)

Update src/shared/db/schema/index.ts to export all new schemas.

Run: `bun run db:generate && bun run db:migrate`
  </action>
  <verify>
`bun run db:migrate` succeeds without errors.
Query: `psql $DATABASE_URL -c "\dt"` shows projects, invitations, invite_links tables.
  </verify>
  <done>
Projects, invitations, and invite_links tables exist in database with correct columns and foreign keys.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create invitations service and email</name>
  <files>
    src/features/invitations/invitations.types.ts
    src/features/invitations/invitations.email.ts
    src/features/invitations/invitations.service.ts
  </files>
  <action>
Create src/features/invitations/ directory structure.

**invitations.types.ts:**
```typescript
export interface CreateInvitationInput {
  orgId: string;
  email: string;
  invitedById: string;
  role?: string;
}

export interface CreateLinkInput {
  orgId: string;
  createdById: string;
  role?: string;
}

export type InvitationResult =
  | { type: 'invited'; email: string }
  | { type: 'existing'; userId: string };
```

**invitations.email.ts:**
- Use existing Resend pattern from src/features/auth/auth.email.ts
- sendInvitationEmail(email: string, token: string, orgName: string, inviterEmail?: string)
- sendAddedToOrgEmail(email: string, orgName: string, addedByEmail: string) - for existing users

**invitations.service.ts:**
- Use nanoid(32) for secure token generation
- Hash tokens with Argon2 before storage (same options as auth: memoryCost 65536, timeCost 3, parallelism 4)
- INVITE_EXPIRY_DAYS = 7 (fixed per user decision)

Functions:
1. createEmailInvitation(input: CreateInvitationInput):
   - Check if user already exists in org -> if yes, auto-add and send notification email (per RESEARCH recommendation)
   - Generate token with nanoid, hash with Argon2
   - Insert into invitations table
   - Send invitation email with APP_URL/join?token={token}
   - Return { type: 'invited' } or { type: 'existing' }

2. createShareableLink(input: CreateLinkInput):
   - Generate token, hash, insert into invite_links
   - Return { id, url: `${APP_URL}/join/${token}`, expiresAt }

3. acceptInvitation(token: string, userId: string):
   - Query all non-expired, non-accepted invitations
   - For each, verify hash against provided token
   - On match: mark acceptedAt, update user.orgId
   - IMPORTANT: Always do hash comparison even on no match (timing attack prevention)
   - Return { success: true, orgId } or { success: false, error: 'Invalid or expired invitation' }

4. acceptInviteLink(token: string, userId: string):
   - Similar to acceptInvitation but for invite_links
   - Increment usageCount on success
   - Do NOT mark as accepted (links are reusable until expiry)
  </action>
  <verify>
TypeScript compiles: `bun run typecheck` passes.
Unit test creates invitation and verifies token hash is different from plaintext token.
  </verify>
  <done>
Invitation service handles email invites, shareable links, and accept flows with proper token hashing and timing-safe comparisons.
  </done>
</task>

<task type="auto">
  <name>Task 3: Create invitation routes and wire to app</name>
  <files>
    src/features/invitations/invitations.routes.ts
    src/features/invitations/index.ts
    src/features/projects/projects.service.ts
    src/features/projects/projects.routes.ts
    src/features/projects/projects.types.ts
    src/features/projects/index.ts
    src/index.ts
    src/shared/lib/env.ts
  </files>
  <action>
**invitations.routes.ts:**
Create Hono router with routes:

POST /api/v1/invitations - Create email invitation (auth required)
- Body: { email: string, role?: string }
- Get orgId from authenticated user's org
- Call createEmailInvitation
- Return 201 with { type, email } or { type, userId }

POST /api/v1/invite-links - Create shareable link (auth required)
- Body: { role?: string }
- Call createShareableLink
- Return 201 with { id, url, expiresAt }

POST /api/v1/invitations/accept - Accept invitation (auth required)
- Body: { token: string }
- Call acceptInvitation or acceptInviteLink based on token format
- Return 200 with { success, orgId } or 400 with error

Use Zod validation with @hono/zod-validator for all request bodies.
Use auth middleware from src/features/auth/auth.middleware.ts.

**invitations/index.ts:** Export routes and types.

**projects/:** Create minimal project CRUD:
- projects.types.ts: CreateProjectInput, Project types
- projects.service.ts: createProject, getProjectsByOrg, getProjectById
- projects.routes.ts: POST /api/v1/projects, GET /api/v1/projects, GET /api/v1/projects/:id
- projects/index.ts: Export routes

**src/index.ts:** Mount invitation and project routes.

**src/shared/lib/env.ts:** Ensure APP_URL is validated (should already exist from 01-02).
  </action>
  <verify>
`bun run dev` starts without errors.

Test with curl:
1. Register a user, get JWT
2. POST /api/v1/invitations with { email: "test@example.com" } - returns 201
3. POST /api/v1/invite-links - returns 201 with URL
4. POST /api/v1/projects with { name: "Test Project" } - returns 201
  </verify>
  <done>
Invitation and project endpoints work with authentication, proper validation, and database persistence.
  </done>
</task>

</tasks>

<verification>
1. All new tables exist: `psql $DATABASE_URL -c "\dt"` shows projects, invitations, invite_links
2. TypeScript compiles: `bun run typecheck` passes
3. Linting passes: `bun run lint` has no errors
4. Server starts: `bun run dev` runs without errors
5. Integration test: Create invitation, accept it, verify user's orgId updated
</verification>

<success_criteria>
- Admin can invite users via email (POST /api/v1/invitations returns 201)
- Admin can create shareable links (POST /api/v1/invite-links returns URL with 7-day expiry)
- User can accept invitation (POST /api/v1/invitations/accept updates user's org)
- Invitation tokens are hashed in database (tokenHash column contains Argon2 hash, not plaintext)
- Projects can be created and listed per organization
</success_criteria>

<output>
After completion, create `.planning/phases/02-team-access/02-01-SUMMARY.md`
</output>
