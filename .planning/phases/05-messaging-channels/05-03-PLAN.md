---
phase: 05-messaging-channels
plan: 03
type: execute
wave: 2
depends_on: ["05-01"]
files_modified:
  - src/features/whatsapp/whatsapp.client.ts
  - src/features/whatsapp/whatsapp.handlers.ts
  - src/features/whatsapp/whatsapp.webhooks.ts
  - src/features/whatsapp/whatsapp.types.ts
  - src/features/whatsapp/index.ts
  - src/index.ts
autonomous: true
user_setup:
  - service: whatsapp
    why: "WhatsApp Cloud API credentials required"
    env_vars:
      - name: WHATSAPP_ACCESS_TOKEN
        source: "Meta Developer Console -> WhatsApp -> API Setup -> Access Token"
      - name: WHATSAPP_PHONE_NUMBER_ID
        source: "Meta Developer Console -> WhatsApp -> API Setup -> Phone Number ID"
      - name: WHATSAPP_VERIFY_TOKEN
        source: "Create a random string, use same value in Meta webhook config"
      - name: WHATSAPP_APP_SECRET
        source: "Meta Developer Console -> App Settings -> App Secret"
    dashboard_config:
      - task: "Configure webhook URL"
        location: "Meta Developer Console -> WhatsApp -> Configuration -> Webhook URL"
      - task: "Subscribe to messages webhook field"
        location: "Meta Developer Console -> WhatsApp -> Configuration -> Webhook fields"

must_haves:
  truths:
    - "WhatsApp webhook receives messages"
    - "Webhook signature is verified"
    - "Bot sends reply messages via Cloud API"
    - "User sessions track last project context"
  artifacts:
    - path: "src/features/whatsapp/whatsapp.client.ts"
      provides: "WhatsApp SDK client wrapper"
      contains: "createWhatsAppClient"
    - path: "src/features/whatsapp/whatsapp.webhooks.ts"
      provides: "Webhook routes for Hono"
      exports: ["whatsappWebhook"]
    - path: "src/features/whatsapp/whatsapp.handlers.ts"
      provides: "Message handling logic"
      contains: "handleIncomingMessage"
  key_links:
    - from: "src/features/whatsapp/whatsapp.webhooks.ts"
      to: "src/index.ts"
      via: "route registration"
      pattern: "app\\.route.*whatsapp"
    - from: "src/features/whatsapp/whatsapp.handlers.ts"
      to: "user_messaging table"
      via: "phone number lookup"
      pattern: "userMessaging"
---

<objective>
Implement WhatsApp Cloud API integration using @great-detail/whatsapp SDK.

Purpose: Enable users to interact with BlockBot agent via WhatsApp Business (MSG-01).
Output: Complete WhatsApp integration with webhook verification, message handling, and reply sending.
</objective>

<execution_context>
@/Users/dio/.claude/get-shit-done/workflows/execute-plan.md
@/Users/dio/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-messaging-channels/05-RESEARCH.md

@src/shared/lib/env.ts
@src/shared/db/schema/user-messaging.ts
@src/index.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create WhatsApp client and types</name>
  <files>src/features/whatsapp/whatsapp.types.ts, src/features/whatsapp/whatsapp.client.ts</files>
  <action>
1. Install dependency:
```bash
bun add @great-detail/whatsapp
```

2. Create whatsapp.types.ts:
```typescript
export interface IncomingMessage {
  messageId: string;
  from: string;  // Phone number
  text: string;
  timestamp: Date;
}

export interface OutgoingMessage {
  to: string;  // Phone number
  text: string;
}

export interface WebhookEntry {
  id: string;
  changes: Array<{
    field: string;
    value: {
      messaging_product: string;
      metadata: {
        display_phone_number: string;
        phone_number_id: string;
      };
      messages?: Array<{
        id: string;
        from: string;
        timestamp: string;
        type: string;
        text?: { body: string };
      }>;
    };
  }>;
}

export interface WebhookPayload {
  object: string;
  entry: WebhookEntry[];
}
```

3. Create whatsapp.client.ts:
```typescript
import Client from '@great-detail/whatsapp';
import { env } from '../../shared/lib/env';
import { logger } from '../../shared/lib/logger';

let client: Client | null = null;

export function isWhatsAppConfigured(): boolean {
  return !!(
    env.WHATSAPP_ACCESS_TOKEN &&
    env.WHATSAPP_PHONE_NUMBER_ID &&
    env.WHATSAPP_VERIFY_TOKEN &&
    env.WHATSAPP_APP_SECRET
  );
}

export function getWhatsAppClient(): Client | null {
  if (!isWhatsAppConfigured()) {
    logger.warn('WhatsApp not configured - missing environment variables');
    return null;
  }

  if (!client) {
    client = new Client({
      request: {
        headers: {
          Authorization: `Bearer ${env.WHATSAPP_ACCESS_TOKEN}`,
        },
      },
    });
  }

  return client;
}

export async function sendWhatsAppMessage(to: string, text: string): Promise<boolean> {
  const wa = getWhatsAppClient();
  if (!wa) return false;

  try {
    await wa.message.createMessage({
      phoneNumberID: env.WHATSAPP_PHONE_NUMBER_ID!,
      to,
      type: 'text',
      text: { body: text },
    });
    return true;
  } catch (err) {
    logger.error({ err, to }, 'Failed to send WhatsApp message');
    return false;
  }
}
```
  </action>
  <verify>bun run typecheck passes</verify>
  <done>WhatsApp client wrapper with graceful degradation when not configured</done>
</task>

<task type="auto">
  <name>Task 2: Create message handlers</name>
  <files>src/features/whatsapp/whatsapp.handlers.ts</files>
  <action>
Create whatsapp.handlers.ts:

```typescript
import { db, schema } from '../../shared/db';
import { eq } from 'drizzle-orm';
import { sendWhatsAppMessage } from './whatsapp.client';
import { logger } from '../../shared/lib/logger';
import type { IncomingMessage } from './whatsapp.types';

/**
 * Get user ID from WhatsApp phone number
 */
export async function getUserIdFromWhatsApp(phone: string): Promise<string | null> {
  const record = await db.query.userMessaging.findFirst({
    where: eq(schema.userMessaging.whatsappPhone, phone),
    columns: { userId: true },
  });
  return record?.userId ?? null;
}

/**
 * Connect WhatsApp account to user
 */
export async function connectWhatsAppAccount(
  phone: string,
  userId: string
): Promise<{ success: boolean; error?: string }> {
  try {
    await db
      .insert(schema.userMessaging)
      .values({
        userId,
        whatsappPhone: phone,
        whatsappVerified: true,
        updatedAt: new Date(),
      })
      .onConflictDoUpdate({
        target: schema.userMessaging.userId,
        set: {
          whatsappPhone: phone,
          whatsappVerified: true,
          updatedAt: new Date(),
        },
      });
    return { success: true };
  } catch (err) {
    logger.error({ err, phone, userId }, 'Failed to connect WhatsApp account');
    return { success: false, error: 'Database error' };
  }
}

/**
 * Handle incoming WhatsApp message
 */
export async function handleIncomingMessage(message: IncomingMessage): Promise<void> {
  logger.info({ messageId: message.messageId, from: message.from }, 'Processing WhatsApp message');

  const userId = await getUserIdFromWhatsApp(message.from);

  if (!userId) {
    // User not linked - send instructions
    await sendWhatsAppMessage(
      message.from,
      'Welcome to BlockBot! To connect your account, please use the web app and click "Connect WhatsApp".'
    );
    return;
  }

  // Check for commands
  const text = message.text.trim().toLowerCase();

  if (text === '/help' || text === 'help') {
    await sendWhatsAppMessage(
      message.from,
      'BlockBot Commands:\n\n' +
      '- "switch" - Change project context\n' +
      '- "status" - View current project status\n' +
      '- "help" - Show this message\n\n' +
      'Or ask me anything about your tasks!'
    );
    return;
  }

  if (text === '/switch' || text === 'switch') {
    // For now, prompt to use web or Telegram (WhatsApp doesn't have inline keyboards)
    await sendWhatsAppMessage(
      message.from,
      'To switch projects, reply with the project name.\n\n' +
      'Or use the web app for a full project list.'
    );
    return;
  }

  // Placeholder for NLU processing (Plan 06)
  await sendWhatsAppMessage(
    message.from,
    'Thanks for your message! Natural language processing is coming soon.\n\n' +
    'Type "help" to see available commands.'
  );
}
```
  </action>
  <verify>bun run typecheck passes</verify>
  <done>Message handlers process incoming WhatsApp messages with basic commands</done>
</task>

<task type="auto">
  <name>Task 3: Create webhook routes and register in app</name>
  <files>src/features/whatsapp/whatsapp.webhooks.ts, src/features/whatsapp/index.ts, src/index.ts</files>
  <action>
1. Create whatsapp.webhooks.ts following RESEARCH.md Pattern 5:

```typescript
import { Hono } from 'hono';
import crypto from 'crypto';
import { env } from '../../shared/lib/env';
import { isWhatsAppConfigured } from './whatsapp.client';
import { handleIncomingMessage } from './whatsapp.handlers';
import { logger } from '../../shared/lib/logger';
import type { WebhookPayload } from './whatsapp.types';

const app = new Hono();

/**
 * Verify webhook signature from Meta
 */
function verifySignature(body: string, signature: string | undefined): boolean {
  if (!signature || !env.WHATSAPP_APP_SECRET) return false;

  const expectedSig = crypto
    .createHmac('sha256', env.WHATSAPP_APP_SECRET)
    .update(body)
    .digest('hex');

  return signature === `sha256=${expectedSig}`;
}

// Webhook verification (GET) - Meta sends this to verify endpoint
app.get('/webhook/whatsapp', (c) => {
  const mode = c.req.query('hub.mode');
  const token = c.req.query('hub.verify_token');
  const challenge = c.req.query('hub.challenge');

  if (!isWhatsAppConfigured()) {
    return c.text('WhatsApp not configured', 503);
  }

  if (mode === 'subscribe' && token === env.WHATSAPP_VERIFY_TOKEN) {
    logger.info('WhatsApp webhook verified');
    return c.text(challenge ?? '');
  }

  logger.warn({ mode, token }, 'WhatsApp webhook verification failed');
  return c.text('Forbidden', 403);
});

// Webhook events (POST) - Meta sends message events here
app.post('/webhook/whatsapp', async (c) => {
  if (!isWhatsAppConfigured()) {
    return c.json({ error: 'WhatsApp not configured' }, 503);
  }

  const body = await c.req.text();
  const signature = c.req.header('x-hub-signature-256');

  // Verify signature
  if (!verifySignature(body, signature)) {
    logger.warn('WhatsApp webhook signature verification failed');
    return c.text('Invalid signature', 401);
  }

  // Parse and process messages
  try {
    const payload: WebhookPayload = JSON.parse(body);

    for (const entry of payload.entry ?? []) {
      for (const change of entry.changes ?? []) {
        if (change.field === 'messages' && change.value.messages) {
          for (const message of change.value.messages) {
            if (message.type === 'text' && message.text?.body) {
              await handleIncomingMessage({
                messageId: message.id,
                from: message.from,
                text: message.text.body,
                timestamp: new Date(Number(message.timestamp) * 1000),
              });
            }
          }
        }
      }
    }
  } catch (err) {
    logger.error({ err }, 'Failed to process WhatsApp webhook');
  }

  // Always return 200 to acknowledge receipt (Meta requirement)
  return c.text('OK');
});

export default app;
```

2. Create index.ts barrel export:
```typescript
export { default as whatsappWebhook } from './whatsapp.webhooks';
export { isWhatsAppConfigured, sendWhatsAppMessage } from './whatsapp.client';
export type { IncomingMessage, OutgoingMessage } from './whatsapp.types';
```

3. Register route in src/index.ts:
```typescript
import { whatsappWebhook } from './features/whatsapp';

// After telegram route registration
app.route('', whatsappWebhook);
```
  </action>
  <verify>bun run typecheck passes, bun run test passes, GET /webhook/whatsapp responds correctly</verify>
  <done>WhatsApp webhook routes registered, signature verification implemented</done>
</task>

</tasks>

<verification>
- [ ] @great-detail/whatsapp installed
- [ ] Client gracefully handles missing env vars
- [ ] GET /webhook/whatsapp handles Meta verification challenge
- [ ] POST /webhook/whatsapp verifies x-hub-signature-256
- [ ] Messages parsed and handler invoked
- [ ] Reply messages sent via Cloud API
- [ ] bun run typecheck and bun run test pass
</verification>

<success_criteria>
- WhatsApp webhook endpoints respond at /webhook/whatsapp
- Signature verification rejects invalid requests
- Basic commands (help, switch) work
- Unlinked users receive connection instructions
- App starts without errors when WhatsApp env vars not set
</success_criteria>

<output>
After completion, create `.planning/phases/05-messaging-channels/05-03-SUMMARY.md`
</output>
