---
phase: 05-messaging-channels
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/shared/db/schema/user-messaging.ts
  - src/shared/db/schema/comments.ts
  - src/shared/db/schema/notifications.ts
  - src/shared/db/schema/index.ts
  - src/shared/lib/env.ts
autonomous: true

must_haves:
  truths:
    - "User messaging preferences can be stored in database"
    - "Comments can be stored with @mention references"
    - "Notifications can be tracked per user"
  artifacts:
    - path: "src/shared/db/schema/user-messaging.ts"
      provides: "User messaging preferences and platform connections"
      contains: "userMessaging"
    - path: "src/shared/db/schema/comments.ts"
      provides: "Comments with polymorphic targets and mentions"
      contains: "comments"
    - path: "src/shared/db/schema/notifications.ts"
      provides: "Notification tracking with read state"
      contains: "notifications"
  key_links:
    - from: "src/shared/db/schema/user-messaging.ts"
      to: "users table"
      via: "foreign key userId"
      pattern: "references.*users"
    - from: "src/shared/db/schema/comments.ts"
      to: "users and projects tables"
      via: "foreign keys"
      pattern: "references.*users|projects"
---

<objective>
Create database schemas for messaging channels, comments, and notifications.

Purpose: Foundation schemas required by all messaging, comment, and notification features in Phase 5.
Output: Three new schema files (user-messaging, comments, notifications) with proper relations and indexes.
</objective>

<execution_context>
@/Users/dio/.claude/get-shit-done/workflows/execute-plan.md
@/Users/dio/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-messaging-channels/05-RESEARCH.md

@src/shared/db/schema/users.ts
@src/shared/db/schema/projects.ts
@src/shared/db/schema/tasks.ts
@src/shared/db/schema/deliverables.ts
@src/shared/db/schema/index.ts
@src/shared/lib/env.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create user-messaging schema</name>
  <files>src/shared/db/schema/user-messaging.ts</files>
  <action>
Create user_messaging table schema following existing patterns:

```typescript
// Fields required (from RESEARCH.md Pattern 8):
id: uuid PK defaultRandom
userId: uuid FK to users (unique, cascade delete)

// Telegram connection
telegramChatId: varchar(100) nullable
telegramUsername: varchar(100) nullable
telegramVerified: boolean default false

// WhatsApp connection
whatsappPhone: varchar(20) nullable
whatsappVerified: boolean default false

// Preferences
messagingEnabled: boolean default true
dailyCheckinEnabled: boolean default false
weeklyRecapEnabled: boolean default false

// Context tracking
lastProjectId: uuid nullable (no FK - may reference deleted project)

createdAt: timestamp with timezone defaultNow
updatedAt: timestamp with timezone defaultNow
```

Add index on telegramChatId and whatsappPhone for lookup during webhook processing.
Export table and relations.
  </action>
  <verify>bun run typecheck passes</verify>
  <done>user_messaging schema exists with all fields, indexes, and relations</done>
</task>

<task type="auto">
  <name>Task 2: Create comments and notifications schemas</name>
  <files>src/shared/db/schema/comments.ts, src/shared/db/schema/notifications.ts</files>
  <action>
Create comments table (from RESEARCH.md Code Examples):

```typescript
// comments.ts
id: uuid PK defaultRandom
projectId: uuid FK to projects (cascade delete)

// Polymorphic target (like dependencies pattern from Phase 4)
targetType: varchar(20) not null // 'task' | 'deliverable'
targetId: uuid not null

// Content
content: text not null
authorId: uuid FK to users (cascade delete)

// Resolved @mentions (user IDs array)
mentions: jsonb default [] (typed as string[])

createdAt: timestamp with timezone defaultNow
updatedAt: timestamp with timezone defaultNow
```

Create notifications table:

```typescript
// notifications.ts
id: uuid PK defaultRandom
userId: uuid FK to users (cascade delete)

type: varchar(50) not null // 'mention' | 'comment' | 'assignment' | 'status_change' | 'due_soon'

// Actor who triggered notification (nullable for system notifications)
actorId: uuid FK to users (set null on delete) nullable

// Target item (polymorphic)
targetType: varchar(20) not null // 'task' | 'deliverable'
targetId: uuid not null
projectId: uuid FK to projects (cascade delete)

// Related comment (for mention/comment notifications)
commentId: uuid FK to comments (cascade delete) nullable

// State
read: boolean default false

createdAt: timestamp with timezone defaultNow
```

Add indexes:
- comments: (targetType, targetId) for listing comments on item
- comments: (projectId) for project-scoped queries
- notifications: (userId, read) for unread count
- notifications: (userId, createdAt DESC) for feed pagination
  </action>
  <verify>bun run typecheck passes</verify>
  <done>comments and notifications schemas exist with indexes and relations</done>
</task>

<task type="auto">
  <name>Task 3: Update schema exports and environment variables</name>
  <files>src/shared/db/schema/index.ts, src/shared/lib/env.ts</files>
  <action>
1. Add exports to src/shared/db/schema/index.ts:
```typescript
export * from './user-messaging';
export * from './comments';
export * from './notifications';
```

2. Add messaging environment variables to src/shared/lib/env.ts:
```typescript
// Telegram Bot (optional - messaging disabled if not configured)
TELEGRAM_BOT_TOKEN: z.string().optional(),

// WhatsApp Cloud API (optional - messaging disabled if not configured)
WHATSAPP_ACCESS_TOKEN: z.string().optional(),
WHATSAPP_PHONE_NUMBER_ID: z.string().optional(),
WHATSAPP_VERIFY_TOKEN: z.string().optional(),
WHATSAPP_APP_SECRET: z.string().optional(),
```

All messaging env vars are optional - messaging features gracefully degrade when not configured (same pattern as S3).

3. Run migration:
```bash
bun run db:generate
bun run db:migrate
```
  </action>
  <verify>bun run db:migrate succeeds, bun run typecheck passes</verify>
  <done>Schema exports added, env vars defined, migration applied</done>
</task>

</tasks>

<verification>
- [ ] All three schema files exist and export correctly
- [ ] bun run typecheck passes with no errors
- [ ] bun run db:migrate applies schemas to database
- [ ] Environment variables are optional (app starts without them)
</verification>

<success_criteria>
- user_messaging, comments, notifications tables exist in database
- Schemas have proper foreign keys, indexes, and relations
- Environment variables for Telegram and WhatsApp are defined as optional
- All existing tests continue to pass
</success_criteria>

<output>
After completion, create `.planning/phases/05-messaging-channels/05-01-SUMMARY.md`
</output>
