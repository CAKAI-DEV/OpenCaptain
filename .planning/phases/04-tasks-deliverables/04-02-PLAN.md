---
phase: 04-tasks-deliverables
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - src/shared/db/schema/deliverable-types.ts
  - src/shared/db/schema/deliverables.ts
  - src/shared/db/schema/index.ts
  - src/features/deliverables/deliverable-presets.ts
  - src/features/deliverables/deliverable-types.service.ts
  - src/features/deliverables/deliverables.types.ts
  - src/features/deliverables/deliverables.service.ts
  - src/features/deliverables/deliverables.routes.ts
  - src/features/deliverables/index.ts
  - src/index.ts
autonomous: true

must_haves:
  truths:
    - "Admin can create deliverable block types with custom status flows"
    - "Admin can define which status transitions are allowed per type"
    - "Preset templates are available: Bug, Feature, Article, Video, Social Post, Design"
    - "User can create deliverables of a specific type"
    - "Deliverable status transitions are validated against type's configured flow"
  artifacts:
    - path: "src/shared/db/schema/deliverable-types.ts"
      provides: "Deliverable type definitions with JSONB config"
      contains: "DeliverableTypeConfig"
    - path: "src/shared/db/schema/deliverables.ts"
      provides: "Deliverables table linked to types"
      contains: "deliverableTypeId"
    - path: "src/features/deliverables/deliverable-presets.ts"
      provides: "Preset templates for Bug, Feature, Article, Video, Social Post, Design"
      contains: "PRESET_TEMPLATES"
    - path: "src/features/deliverables/deliverables.service.ts"
      provides: "Deliverable CRUD with status transition validation"
      exports: ["createDeliverable", "updateDeliverable", "validateStatusTransition"]
  key_links:
    - from: "src/features/deliverables/deliverables.service.ts"
      to: "src/features/deliverables/deliverable-types.service.ts"
      via: "type config lookup"
      pattern: "deliverableTypesService\\.get"
    - from: "src/features/deliverables/deliverables.service.ts"
      to: "src/shared/db/schema/deliverables.ts"
      via: "Drizzle queries"
      pattern: "schema\\.deliverables"
---

<objective>
Create deliverable types with configurable status flows and the deliverables data model, including preset templates for common PM and content workflows.

Purpose: Enable admins to define custom deliverable types with their own status flows, and users to create deliverables that follow those configured workflows.
Output: Deliverable types schema with JSONB config, deliverables schema, preset templates, and REST API endpoints.
</objective>

<execution_context>
@/Users/dio/.claude/get-shit-done/workflows/execute-plan.md
@/Users/dio/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-tasks-deliverables/04-CONTEXT.md
@.planning/phases/04-tasks-deliverables/04-RESEARCH.md

Reference existing patterns:
@src/shared/db/schema/projects.ts (schema patterns)
@src/features/projects/projects.service.ts (service patterns)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create deliverable types and deliverables schemas</name>
  <files>
    src/shared/db/schema/deliverable-types.ts
    src/shared/db/schema/deliverables.ts
    src/shared/db/schema/index.ts
  </files>
  <action>
Create schemas for deliverable types and deliverables following 04-RESEARCH.md patterns:

1. Create `src/shared/db/schema/deliverable-types.ts`:
   - Define TypeScript interfaces (not stored in DB, used for JSONB typing):
     - StatusDefinition: { id: string, name: string, color: string, isFinal: boolean }
     - StatusTransition: { from: string, to: string }
     - FieldDefinition: { id: string, name: string, type: FieldType, required: boolean, options?: string[], relationTo?: 'task' | 'deliverable' }
     - FieldType: 'text' | 'number' | 'date' | 'select' | 'multi_select' | 'url' | 'file' | 'relation'
     - DeliverableTypeConfig: { statuses: StatusDefinition[], transitions: StatusTransition[], fields: FieldDefinition[] }
   - Create deliverableTypes table:
     - id: uuid primary key defaultRandom()
     - projectId: uuid referencing projects.id with cascade delete
     - name: varchar(255) not null
     - description: text nullable
     - icon: varchar(50) nullable (emoji or icon name)
     - config: jsonb with $type<DeliverableTypeConfig> not null
     - isPreset: boolean not null default false
     - createdAt/updatedAt: timestamps

2. Create `src/shared/db/schema/deliverables.ts`:
   - Create deliverables table:
     - id: uuid primary key defaultRandom()
     - projectId: uuid referencing projects.id with cascade delete
     - squadId: uuid referencing squads.id with set null on delete (optional)
     - deliverableTypeId: uuid referencing deliverableTypes.id not null
     - title: varchar(500) not null
     - description: text nullable
     - status: varchar(100) not null (validated against type's status flow at service layer)
     - assigneeId: uuid referencing users.id with set null on delete
     - createdById: uuid referencing users.id not null
     - dueDate: timestamp with timezone nullable
     - completedAt: timestamp with timezone nullable
     - customFieldValues: jsonb with $type<Record<string, unknown>> default {}
     - createdAt/updatedAt: timestamps

3. Export both from `src/shared/db/schema/index.ts`
  </action>
  <verify>
Run `bun run typecheck` - no TypeScript errors.
Run `bun run db:generate` - migrations generated successfully.
  </verify>
  <done>
Deliverable types and deliverables schemas created with JSONB config for status flows and field definitions.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create preset templates and deliverable types service</name>
  <files>
    src/features/deliverables/deliverable-presets.ts
    src/features/deliverables/deliverable-types.service.ts
    src/features/deliverables/deliverables.types.ts
    src/features/deliverables/index.ts
  </files>
  <action>
Create preset templates and deliverable types service:

1. Create `src/features/deliverables/deliverable-presets.ts`:
   Copy the PRESET_TEMPLATES from 04-RESEARCH.md Code Examples section. Include all 6 presets:
   - bug: Open -> In Progress -> Testing -> Resolved -> Closed
   - feature: Backlog -> Spec -> Design -> Development -> Review -> Done
   - article: Ideation -> Outline -> Writing -> Editing -> Review -> Published
   - video: Ideation -> Scripting -> Production -> Editing -> Review -> Published
   - social_post: Draft -> Review -> Scheduled -> Published
   - design: Brief -> Exploration -> Refinement -> Review -> Approved

   Export as PRESET_TEMPLATES with type Record<string, DeliverableTypeConfig>.

2. Create `src/features/deliverables/deliverables.types.ts`:
   - CreateDeliverableTypeInput: { projectId, name, description?, icon?, config }
   - UpdateDeliverableTypeInput: Partial of editable fields
   - CreateDeliverableInput: { projectId, squadId?, deliverableTypeId, title, description?, assigneeId?, dueDate?, customFieldValues? }
   - UpdateDeliverableInput: Partial of editable fields including status
   - DeliverableTypeResult: inferred select type
   - DeliverableResult: inferred select type

3. Create `src/features/deliverables/deliverable-types.service.ts`:
   - createDeliverableType(input): Insert new type, return
   - createFromPreset(projectId, presetKey): Create type from PRESET_TEMPLATES
   - updateDeliverableType(typeId, input): Update type config
   - deleteDeliverableType(typeId): Delete (will cascade to deliverables)
   - getDeliverableType(typeId): Fetch single type
   - listDeliverableTypes(projectId): List types for project
   - validateStatusTransition(typeId, fromStatus, toStatus): Check if transition is allowed in config
   - getInitialStatus(typeId): Get first status from config (for new deliverables)

4. Create barrel export `src/features/deliverables/index.ts`
  </action>
  <verify>
Run `bun run typecheck` - no TypeScript errors.
  </verify>
  <done>
Preset templates created with 6 types (bug, feature, article, video, social_post, design). Deliverable types service with CRUD and status transition validation.
  </done>
</task>

<task type="auto">
  <name>Task 3: Create deliverables service and routes</name>
  <files>
    src/features/deliverables/deliverables.service.ts
    src/features/deliverables/deliverables.routes.ts
    src/index.ts
  </files>
  <action>
Create deliverables service and REST API:

1. Create `src/features/deliverables/deliverables.service.ts`:
   - createDeliverable(input, createdById):
     - Fetch deliverable type, verify exists
     - Get initial status from type config (first status in statuses array)
     - Insert deliverable with initial status
     - Return deliverable
   - updateDeliverable(deliverableId, input, userId):
     - Fetch deliverable, verify exists
     - If status is being changed:
       - Validate transition using deliverableTypesService.validateStatusTransition
       - If invalid, throw ApiError 400 'deliverables/invalid-status-transition'
       - If new status has isFinal: true, set completedAt = now
       - If moving away from final status, clear completedAt
     - Update and return
   - deleteDeliverable(deliverableId): Delete deliverable
   - getDeliverable(deliverableId): Fetch with type info
   - listDeliverables(projectId, filters?): Support filters: squadId, assigneeId, status, deliverableTypeId

2. Create `src/features/deliverables/deliverables.routes.ts`:
   - Import Hono, zod, authMiddleware, visibilityMiddleware
   - Create router, apply middleware

   Deliverable Type endpoints (admin only):
   - POST /types - Create deliverable type
   - POST /types/from-preset - Create from preset (body: { projectId, preset: 'bug' | 'feature' | ... })
   - GET /types - List types for project (query: projectId)
   - GET /types/:typeId - Get single type
   - PATCH /types/:typeId - Update type
   - DELETE /types/:typeId - Delete type

   Deliverable endpoints:
   - POST / - Create deliverable
   - GET /:deliverableId - Get single deliverable
   - PATCH /:deliverableId - Update deliverable (validates status transitions)
   - DELETE /:deliverableId - Delete deliverable
   - GET / - List deliverables (query: projectId, squadId?, assigneeId?, status?, deliverableTypeId?)

3. Wire routes in `src/index.ts`:
   - Import deliverablesRoutes from './features/deliverables'
   - Mount at '/api/v1/deliverables'
  </action>
  <verify>
Run `bun run typecheck` - no TypeScript errors.
Run `bun run lint` - no linting errors.
Run `bun run db:migrate` - migrations applied.
Test with curl:
- POST /api/v1/deliverables/types/from-preset with { projectId, preset: 'bug' } returns 201
- POST /api/v1/deliverables with deliverableTypeId returns 201 with initial status
- PATCH with invalid status transition returns 400
  </verify>
  <done>
Deliverables feature complete with types management (including preset creation), deliverable CRUD, and status transition validation.
  </done>
</task>

</tasks>

<verification>
1. Deliverable types can be created with custom status flows
2. Presets can be instantiated for a project (POST /types/from-preset)
3. Deliverables are created with the type's initial status
4. Status transitions are validated against type config
5. Invalid transitions return 400 error
6. Final status sets completedAt timestamp
</verification>

<success_criteria>
- Deliverable types table stores config as JSONB
- 6 preset templates available (bug, feature, article, video, social_post, design)
- Status transition validation works correctly
- Deliverables can be created, updated, deleted
- TypeScript compiles without errors
- Linter passes
</success_criteria>

<output>
After completion, create `.planning/phases/04-tasks-deliverables/04-02-SUMMARY.md`
</output>
