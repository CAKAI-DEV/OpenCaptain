---
phase: 04-tasks-deliverables
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/shared/db/schema/tasks.ts
  - src/shared/db/schema/index.ts
  - src/features/tasks/tasks.types.ts
  - src/features/tasks/tasks.service.ts
  - src/features/tasks/tasks.routes.ts
  - src/features/tasks/index.ts
  - src/index.ts
autonomous: true

must_haves:
  truths:
    - "User can create a task with title, description, assignee, due date, and priority"
    - "User can create subtasks up to 2 levels deep (Task -> Subtask -> Sub-subtask)"
    - "Creating a sub-sub-subtask returns 400 error"
    - "Task status transitions follow fixed flow: todo -> in_progress -> done"
    - "User can edit and delete tasks they have permission to modify"
  artifacts:
    - path: "src/shared/db/schema/tasks.ts"
      provides: "Tasks table with depth field for nesting limit"
      contains: "taskPriorityEnum"
    - path: "src/features/tasks/tasks.service.ts"
      provides: "Task CRUD with 2-level nesting enforcement"
      exports: ["createTask", "updateTask", "deleteTask", "getTask", "listTasks"]
    - path: "src/features/tasks/tasks.routes.ts"
      provides: "REST endpoints for task management"
      min_lines: 100
  key_links:
    - from: "src/features/tasks/tasks.routes.ts"
      to: "src/features/tasks/tasks.service.ts"
      via: "service method calls"
      pattern: "tasksService\\.(create|update|delete|get|list)"
    - from: "src/features/tasks/tasks.service.ts"
      to: "src/shared/db/schema/tasks.ts"
      via: "Drizzle queries"
      pattern: "schema\\.tasks"
---

<objective>
Create the tasks data model and CRUD operations with 2-level subtask nesting, priority levels, and fixed status flow.

Purpose: Enable users to create and manage tasks as the core work items in the project management system.
Output: Tasks schema, service layer with nesting enforcement, REST API endpoints.
</objective>

<execution_context>
@/Users/dio/.claude/get-shit-done/workflows/execute-plan.md
@/Users/dio/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-tasks-deliverables/04-CONTEXT.md
@.planning/phases/04-tasks-deliverables/04-RESEARCH.md

Reference existing patterns:
@src/shared/db/schema/squads.ts (self-referential foreign key pattern)
@src/features/teams/teams.service.ts (service layer patterns)
@src/features/projects/projects.routes.ts (route patterns)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create tasks schema with priority and nesting support</name>
  <files>
    src/shared/db/schema/tasks.ts
    src/shared/db/schema/index.ts
  </files>
  <action>
Create the tasks table schema following the pattern from 04-RESEARCH.md:

1. Create `src/shared/db/schema/tasks.ts`:
   - Define taskPriorityEnum with pgEnum: 'low', 'medium', 'high', 'urgent'
   - Define taskStatusEnum with pgEnum: 'todo', 'in_progress', 'done'
   - Create tasks table with:
     - id: uuid primary key with defaultRandom()
     - projectId: uuid referencing projects.id with cascade delete
     - squadId: uuid referencing squads.id with set null on delete (optional)
     - parentTaskId: uuid self-reference using AnyPgColumn pattern (like squads.ts)
     - depth: integer not null default 0 (0=task, 1=subtask, 2=sub-subtask)
     - title: varchar(500) not null
     - description: text nullable
     - priority: taskPriorityEnum not null default 'medium'
     - status: taskStatusEnum not null default 'todo'
     - assigneeId: uuid referencing users.id with set null on delete
     - createdById: uuid referencing users.id not null
     - dueDate: timestamp with timezone nullable
     - completedAt: timestamp with timezone nullable
     - customFieldValues: jsonb with $type<Record<string, unknown>> default {}
     - createdAt/updatedAt: timestamps

2. Export from `src/shared/db/schema/index.ts`

Do NOT add any indexes yet - keep the schema simple for now.
  </action>
  <verify>
Run `bun run typecheck` - no TypeScript errors.
Run `bun run db:generate` - migration generated successfully.
  </verify>
  <done>
Tasks schema created with priority enum, status enum, depth field for nesting, and self-referential parent relationship.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create tasks service with nesting enforcement</name>
  <files>
    src/features/tasks/tasks.types.ts
    src/features/tasks/tasks.service.ts
    src/features/tasks/index.ts
  </files>
  <action>
Create the tasks service layer with 2-level nesting enforcement:

1. Create `src/features/tasks/tasks.types.ts`:
   - CreateTaskInput: { projectId, squadId?, parentTaskId?, title, description?, priority?, assigneeId?, dueDate?, customFieldValues? }
   - UpdateTaskInput: Partial of editable fields (title, description, priority, status, assigneeId, dueDate, squadId, customFieldValues)
   - TaskResult: inferred select type from tasks table
   - TaskWithSubtasks: TaskResult with subtasks array

2. Create `src/features/tasks/tasks.service.ts`:
   - MAX_DEPTH constant = 2
   - createTask(input, createdById):
     - If parentTaskId provided, fetch parent task
     - Check parent.depth < MAX_DEPTH (if depth >= 2, throw ApiError 400 'tasks/max-depth-exceeded')
     - Set depth = parent.depth + 1, or 0 if no parent
     - Insert and return task
   - updateTask(taskId, input, userId):
     - Fetch task, verify exists (404 if not)
     - Validate status transition (only allow: todo->in_progress, in_progress->done, or reverse)
     - If status changes to 'done', set completedAt = now
     - If status changes from 'done', clear completedAt
     - Update and return
   - deleteTask(taskId, userId):
     - Fetch task, verify exists
     - Delete (cascade will handle subtasks via foreign key)
   - getTask(taskId):
     - Fetch with subtasks (one level deep)
   - listTasks(projectId, filters?):
     - Support filters: squadId, assigneeId, status, parentTaskId (null for top-level)
     - Return array with pagination support

Use ApiError from 'src/shared/middleware/error-handler' for errors.

3. Create `src/features/tasks/index.ts` barrel export.
  </action>
  <verify>
Run `bun run typecheck` - no TypeScript errors.
  </verify>
  <done>
Tasks service created with createTask enforcing 2-level nesting limit, updateTask handling status transitions, and CRUD operations.
  </done>
</task>

<task type="auto">
  <name>Task 3: Create tasks routes and wire to app</name>
  <files>
    src/features/tasks/tasks.routes.ts
    src/index.ts
  </files>
  <action>
Create REST endpoints for task management:

1. Create `src/features/tasks/tasks.routes.ts`:
   - Import Hono, zod, authMiddleware, visibilityMiddleware
   - Create router with Hono()
   - Apply authMiddleware to all routes
   - Apply visibilityMiddleware after auth

   Endpoints:
   - POST / - Create task
     - Validate body with zod: { projectId, squadId?, parentTaskId?, title, description?, priority?, assigneeId?, dueDate?, customFieldValues? }
     - Call tasksService.createTask
     - Return 201 with createResponse

   - GET /:taskId - Get single task with subtasks
     - Validate taskId param
     - Call tasksService.getTask
     - Return 200 with createResponse

   - PATCH /:taskId - Update task
     - Validate body (all fields optional)
     - Call tasksService.updateTask
     - Return 200 with createResponse

   - DELETE /:taskId - Delete task
     - Call tasksService.deleteTask
     - Return 204 no content

   - GET / - List tasks
     - Query params: projectId (required), squadId?, assigneeId?, status?, parentTaskId?, page?, limit?
     - Call tasksService.listTasks
     - Return 200 with createPaginatedResponse

   Follow existing route patterns from projects.routes.ts.

2. Wire routes in `src/index.ts`:
   - Import tasksRoutes from './features/tasks'
   - Mount at '/api/v1/tasks'
  </action>
  <verify>
Run `bun run typecheck` - no TypeScript errors.
Run `bun run lint` - no linting errors.
Run `bun run db:migrate` - migrations applied.
Start server with `bun run dev` and test:
- POST /api/v1/tasks with valid data returns 201
- POST with parentTaskId of sub-subtask returns 400 (max depth)
- GET /api/v1/tasks?projectId=xxx returns task list
  </verify>
  <done>
Tasks REST API complete with routes for CRUD operations, mounted at /api/v1/tasks.
  </done>
</task>

</tasks>

<verification>
1. Tasks can be created with all required fields (title, projectId, createdById)
2. Subtasks can be created with parentTaskId, depth is correctly computed
3. Attempting to create 3rd level nesting returns 400 error
4. Status transitions work: todo -> in_progress -> done
5. Task deletion cascades to subtasks
6. List endpoint supports filtering by project, squad, assignee, status
</verification>

<success_criteria>
- Tasks table exists with priority enum, status enum, depth field
- Service enforces 2-level nesting limit (MAX_DEPTH = 2)
- CRUD endpoints respond correctly
- TypeScript compiles without errors
- Linter passes
</success_criteria>

<output>
After completion, create `.planning/phases/04-tasks-deliverables/04-01-SUMMARY.md`
</output>
