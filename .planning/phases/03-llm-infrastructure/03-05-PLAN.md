---
phase: 03-llm-infrastructure
plan: 05
type: execute
wave: 1
depends_on: []
files_modified:
  - src/shared/db/migrations/0000_enable_pgvector.sql
  - docker-compose.yml
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "pgvector extension is enabled in PostgreSQL"
    - "Migrations can run on fresh database without errors"
  artifacts:
    - path: "src/shared/db/migrations/0000_enable_pgvector.sql"
      provides: "Extension initialization migration"
      contains: "CREATE EXTENSION IF NOT EXISTS vector"
  key_links:
    - from: "src/shared/db/migrations/0000_enable_pgvector.sql"
      to: "src/shared/db/migrations/0005_woozy_zeigeist.sql"
      via: "Migration ordering"
      pattern: "vector\\(1536\\)"
---

<objective>
Ensure pgvector extension is explicitly enabled before migrations that use vector types.

Purpose: Close the "uncertain" gap from VERIFICATION.md - while the Docker image (pgvector/pgvector:pg16) has the extension pre-installed, migrations would fail on databases without it. Adding an explicit CREATE EXTENSION makes the setup robust.

Output: Migration file that runs first to enable pgvector, documented database requirements.
</objective>

<execution_context>
@/Users/dio/.claude/get-shit-done/workflows/execute-plan.md
@/Users/dio/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/phases/03-llm-infrastructure/03-VERIFICATION.md
@src/shared/db/migrations/
@docker-compose.yml
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create pgvector Extension Migration</name>
  <files>src/shared/db/migrations/0000_enable_pgvector.sql</files>
  <action>
Create src/shared/db/migrations/0000_enable_pgvector.sql:

```sql
-- Enable pgvector extension for vector similarity search
-- This must run before any migrations that use the vector type
-- The pgvector/pgvector:pg16 Docker image has the extension pre-installed
-- but this ensures it's enabled in the database

CREATE EXTENSION IF NOT EXISTS vector;
```

The 0000_ prefix ensures this migration runs first, before any other migrations that depend on the vector type (like 0005_woozy_zeigeist.sql which uses `vector(1536)`).

Note: Drizzle migrations run in filename order, so 0000 will run before 0001, 0002, etc.
  </action>
  <verify>bun run db:migrate</verify>
  <done>pgvector extension migration created and runs successfully</done>
</task>

<task type="auto">
  <name>Task 2: Add Database Requirements Comment to docker-compose</name>
  <files>docker-compose.yml</files>
  <action>
Update the postgres service in docker-compose.yml to add a comment documenting the pgvector requirement:

Find the postgres service section and add a comment above it or within it:

```yaml
  postgres:
    # Uses pgvector/pgvector image which has the vector extension pre-installed
    # The 0000_enable_pgvector.sql migration enables the extension in the database
    # Required for embeddings table vector(1536) column and HNSW index
    image: pgvector/pgvector:pg16
```

This documents the dependency for future maintainers.
  </action>
  <verify>docker compose config</verify>
  <done>docker-compose.yml documents pgvector requirement</done>
</task>

</tasks>

<verification>
1. Migration file exists: src/shared/db/migrations/0000_enable_pgvector.sql
2. Migration runs without error: `bun run db:migrate` succeeds
3. Extension enabled: `SELECT * FROM pg_extension WHERE extname = 'vector'` returns row
4. docker-compose.yml has documentation comment
</verification>

<success_criteria>
- pgvector extension migration runs first (0000 prefix)
- Migrations succeed on fresh database
- Extension is enabled before vector column creation
- Database requirements documented in docker-compose.yml
</success_criteria>

<output>
After completion, create `.planning/phases/03-llm-infrastructure/03-05-SUMMARY.md`
</output>
