---
phase: 07-web-ui-analytics
plan: 04
type: execute
wave: 2
depends_on: ["07-01", "07-02"]
files_modified:
  - web/src/app/(dashboard)/projects/[projectId]/board/page.tsx
  - web/src/components/board/kanban-board.tsx
  - web/src/components/board/board-column.tsx
  - web/src/components/board/board-task-card.tsx
  - web/src/hooks/use-optimistic-tasks.ts
  - web/src/hooks/use-tasks.ts
autonomous: true
user_setup: []

must_haves:
  truths:
    - "User can see tasks organized in columns by status (todo, in_progress, done)"
    - "User can drag a task card to another column"
    - "Task status updates immediately on drop (optimistic update)"
    - "Task status persists after page refresh"
  artifacts:
    - path: "web/src/components/board/kanban-board.tsx"
      provides: "Main Kanban board with DnD context"
      exports: ["KanbanBoard"]
    - path: "web/src/components/board/board-column.tsx"
      provides: "Single column (todo/in_progress/done)"
      exports: ["BoardColumn"]
    - path: "web/src/components/board/board-task-card.tsx"
      provides: "Draggable task card"
      exports: ["BoardTaskCard"]
    - path: "web/src/hooks/use-optimistic-tasks.ts"
      provides: "Optimistic update hook for tasks"
      exports: ["useOptimisticTasks"]
  key_links:
    - from: "web/src/components/board/kanban-board.tsx"
      to: "@dnd-kit/core"
      via: "DndContext import"
      pattern: "import.*DndContext.*from.*@dnd-kit"
    - from: "web/src/hooks/use-optimistic-tasks.ts"
      to: "/api/v1/tasks"
      via: "PATCH fetch"
      pattern: "fetch.*tasks.*PATCH"
    - from: "web/src/app/(dashboard)/projects/[projectId]/board/page.tsx"
      to: "web/src/components/board/kanban-board.tsx"
      via: "component import"
      pattern: "import.*KanbanBoard"
---

<objective>
Build Kanban board view with drag-and-drop task cards using dnd-kit and optimistic updates.

Purpose: Allow users to visually manage tasks across status columns with instant feedback.
Output: Working Kanban board that fetches tasks, displays them in columns, and updates status on drag-drop with optimistic UI.
</objective>

<execution_context>
@/Users/dio/.claude/get-shit-done/workflows/execute-plan.md
@/Users/dio/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/07-web-ui-analytics/07-RESEARCH.md
@.planning/phases/07-web-ui-analytics/07-01-SUMMARY.md
@src/features/tasks/tasks.routes.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install dnd-kit and create board components</name>
  <files>
    - web/package.json
    - web/src/components/board/board-column.tsx
    - web/src/components/board/board-task-card.tsx
  </files>
  <action>
Install dnd-kit packages and create the individual board components.

```bash
cd /Users/dio/RnD/web
npm install @dnd-kit/core @dnd-kit/sortable @dnd-kit/utilities
```

Create web/src/components/board/board-column.tsx:
```typescript
'use client'

import { useDroppable } from '@dnd-kit/core'
import { cn } from '@/lib/utils'
import type { TaskStatus } from '@/types/task'

interface BoardColumnProps {
  status: TaskStatus
  children: React.ReactNode
}

const statusLabels: Record<TaskStatus, string> = {
  todo: 'To Do',
  in_progress: 'In Progress',
  done: 'Done',
}

const statusColors: Record<TaskStatus, string> = {
  todo: 'border-t-slate-400',
  in_progress: 'border-t-blue-500',
  done: 'border-t-green-500',
}

export function BoardColumn({ status, children }: BoardColumnProps) {
  const { setNodeRef, isOver } = useDroppable({
    id: status,
  })

  return (
    <div
      ref={setNodeRef}
      className={cn(
        'flex flex-col w-80 shrink-0 bg-muted/50 rounded-lg border-t-4',
        statusColors[status],
        isOver && 'bg-muted'
      )}
    >
      <div className="p-3 font-semibold text-sm">
        {statusLabels[status]}
      </div>
      <div className="flex-1 p-2 space-y-2 overflow-y-auto min-h-[200px]">
        {children}
      </div>
    </div>
  )
}
```

Create web/src/components/board/board-task-card.tsx:
```typescript
'use client'

import { useSortable } from '@dnd-kit/sortable'
import { CSS } from '@dnd-kit/utilities'
import { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card'
import { Badge } from '@/components/ui/badge'
import { cn } from '@/lib/utils'
import type { Task } from '@/types/task'
import { GripVertical, Calendar, User } from 'lucide-react'

interface BoardTaskCardProps {
  task: Task
  isDragging?: boolean
}

const priorityColors: Record<string, string> = {
  low: 'bg-slate-100 text-slate-700',
  medium: 'bg-blue-100 text-blue-700',
  high: 'bg-orange-100 text-orange-700',
  urgent: 'bg-red-100 text-red-700',
}

export function BoardTaskCard({ task, isDragging }: BoardTaskCardProps) {
  const {
    attributes,
    listeners,
    setNodeRef,
    transform,
    transition,
    isDragging: isSortableDragging,
  } = useSortable({
    id: task.id,
    data: { task },
  })

  const style = {
    transform: CSS.Transform.toString(transform),
    transition,
  }

  return (
    <Card
      ref={setNodeRef}
      style={style}
      className={cn(
        'cursor-grab active:cursor-grabbing',
        (isDragging || isSortableDragging) && 'opacity-50 shadow-lg rotate-2'
      )}
      {...attributes}
      {...listeners}
    >
      <CardHeader className="p-3 pb-2">
        <div className="flex items-start gap-2">
          <GripVertical className="h-4 w-4 text-muted-foreground shrink-0 mt-0.5" />
          <CardTitle className="text-sm font-medium leading-tight">
            {task.title}
          </CardTitle>
        </div>
      </CardHeader>
      <CardContent className="p-3 pt-0 space-y-2">
        <div className="flex flex-wrap gap-1">
          <Badge variant="secondary" className={priorityColors[task.priority]}>
            {task.priority}
          </Badge>
        </div>
        <div className="flex items-center gap-3 text-xs text-muted-foreground">
          {task.dueDate && (
            <span className="flex items-center gap-1">
              <Calendar className="h-3 w-3" />
              {new Date(task.dueDate).toLocaleDateString()}
            </span>
          )}
          {task.assigneeId && (
            <span className="flex items-center gap-1">
              <User className="h-3 w-3" />
              Assigned
            </span>
          )}
        </div>
      </CardContent>
    </Card>
  )
}
```
  </action>
  <verify>
```bash
cd /Users/dio/RnD/web
grep -q "@dnd-kit/core" package.json && echo "dnd-kit installed"
test -f src/components/board/board-column.tsx && echo "Column OK"
test -f src/components/board/board-task-card.tsx && echo "Card OK"
grep -q "useDroppable" src/components/board/board-column.tsx && echo "Droppable OK"
grep -q "useSortable" src/components/board/board-task-card.tsx && echo "Sortable OK"
```
  </verify>
  <done>dnd-kit installed, BoardColumn (droppable) and BoardTaskCard (sortable/draggable) components created</done>
</task>

<task type="auto">
  <name>Task 2: Create optimistic update hook and tasks fetching</name>
  <files>
    - web/src/hooks/use-tasks.ts
    - web/src/hooks/use-optimistic-tasks.ts
  </files>
  <action>
Create hooks for fetching tasks and handling optimistic updates.

Create web/src/hooks/use-tasks.ts:
```typescript
'use client'

import { useState, useEffect, useCallback } from 'react'
import type { Task } from '@/types/task'
import type { PaginatedResponse } from '@/types/api'

interface UseTasksOptions {
  projectId: string
  status?: Task['status']
  assigneeId?: string
  squadId?: string
}

export function useTasks({ projectId, status, assigneeId, squadId }: UseTasksOptions) {
  const [tasks, setTasks] = useState<Task[]>([])
  const [loading, setLoading] = useState(true)
  const [error, setError] = useState<Error | null>(null)

  const fetchTasks = useCallback(async () => {
    setLoading(true)
    try {
      const params = new URLSearchParams({
        projectId,
        limit: '100', // Get all for board view
        parentTaskId: 'null', // Only top-level tasks
      })
      if (status) params.set('status', status)
      if (assigneeId) params.set('assigneeId', assigneeId)
      if (squadId) params.set('squadId', squadId)

      const response = await fetch(`/api/v1/tasks?${params}`, {
        credentials: 'include',
      })
      if (!response.ok) throw new Error('Failed to fetch tasks')

      const data: PaginatedResponse<Task> = await response.json()
      setTasks(data.data)
    } catch (err) {
      setError(err instanceof Error ? err : new Error('Unknown error'))
    } finally {
      setLoading(false)
    }
  }, [projectId, status, assigneeId, squadId])

  useEffect(() => {
    fetchTasks()
  }, [fetchTasks])

  return { tasks, loading, error, refetch: fetchTasks, setTasks }
}
```

Create web/src/hooks/use-optimistic-tasks.ts:
```typescript
'use client'

import { useOptimistic, useTransition, useCallback } from 'react'
import type { Task, UpdateTaskInput } from '@/types/task'

type OptimisticAction = {
  type: 'update'
  taskId: string
  changes: Partial<Task>
}

export function useOptimisticTasks(initialTasks: Task[]) {
  const [isPending, startTransition] = useTransition()

  const [optimisticTasks, addOptimisticUpdate] = useOptimistic(
    initialTasks,
    (state: Task[], action: OptimisticAction) => {
      switch (action.type) {
        case 'update':
          return state.map((task) =>
            task.id === action.taskId
              ? { ...task, ...action.changes }
              : task
          )
        default:
          return state
      }
    }
  )

  const updateTask = useCallback(
    async (taskId: string, changes: UpdateTaskInput) => {
      startTransition(async () => {
        // Optimistically update UI
        addOptimisticUpdate({ type: 'update', taskId, changes })

        try {
          const response = await fetch(`/api/v1/tasks/${taskId}`, {
            method: 'PATCH',
            credentials: 'include',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(changes),
          })

          if (!response.ok) {
            throw new Error('Failed to update task')
          }

          // On success, the optimistic state becomes permanent
          // React will reconcile when transition completes
        } catch (error) {
          // On error, React will revert to the original state
          // because the transition didn't complete successfully
          console.error('Task update failed:', error)
          // Optionally show a toast notification
        }
      })
    },
    [addOptimisticUpdate]
  )

  return {
    tasks: optimisticTasks,
    updateTask,
    isPending,
  }
}
```
  </action>
  <verify>
```bash
cd /Users/dio/RnD/web
test -f src/hooks/use-tasks.ts && echo "Tasks hook OK"
test -f src/hooks/use-optimistic-tasks.ts && echo "Optimistic hook OK"
grep -q "useOptimistic" src/hooks/use-optimistic-tasks.ts && echo "Using React 19 useOptimistic"
grep -q "PATCH" src/hooks/use-optimistic-tasks.ts && echo "PATCH update OK"
```
  </verify>
  <done>useTasks hook fetches tasks from API, useOptimisticTasks provides optimistic updates with rollback on error</done>
</task>

<task type="auto">
  <name>Task 3: Create KanbanBoard and board page</name>
  <files>
    - web/src/components/board/kanban-board.tsx
    - web/src/app/(dashboard)/projects/[projectId]/board/page.tsx
  </files>
  <action>
Create the main Kanban board component and the board page.

Create web/src/components/board/kanban-board.tsx:
```typescript
'use client'

import { useState, useEffect } from 'react'
import {
  DndContext,
  DragOverlay,
  closestCorners,
  KeyboardSensor,
  PointerSensor,
  useSensor,
  useSensors,
  type DragEndEvent,
  type DragStartEvent,
  type DragOverEvent,
} from '@dnd-kit/core'
import {
  SortableContext,
  sortableKeyboardCoordinates,
  verticalListSortingStrategy,
} from '@dnd-kit/sortable'
import { BoardColumn } from './board-column'
import { BoardTaskCard } from './board-task-card'
import { useOptimisticTasks } from '@/hooks/use-optimistic-tasks'
import type { Task, TaskStatus } from '@/types/task'

const COLUMNS: TaskStatus[] = ['todo', 'in_progress', 'done']

interface KanbanBoardProps {
  initialTasks: Task[]
}

export function KanbanBoard({ initialTasks }: KanbanBoardProps) {
  const { tasks, updateTask, isPending } = useOptimisticTasks(initialTasks)
  const [activeTask, setActiveTask] = useState<Task | null>(null)

  const sensors = useSensors(
    useSensor(PointerSensor, {
      activationConstraint: {
        distance: 8, // Require 8px movement before drag starts
      },
    }),
    useSensor(KeyboardSensor, {
      coordinateGetter: sortableKeyboardCoordinates,
    })
  )

  const handleDragStart = (event: DragStartEvent) => {
    const taskId = event.active.id as string
    const task = tasks.find((t) => t.id === taskId)
    if (task) {
      setActiveTask(task)
    }
  }

  const handleDragOver = (event: DragOverEvent) => {
    // Handle drag over columns for visual feedback
    // The actual status change happens on dragEnd
  }

  const handleDragEnd = (event: DragEndEvent) => {
    const { active, over } = event
    setActiveTask(null)

    if (!over) return

    const taskId = active.id as string
    const overId = over.id as string

    // Check if dropped on a column
    if (COLUMNS.includes(overId as TaskStatus)) {
      const newStatus = overId as TaskStatus
      const task = tasks.find((t) => t.id === taskId)

      if (task && task.status !== newStatus) {
        updateTask(taskId, { status: newStatus })
      }
    }
  }

  const getTasksByStatus = (status: TaskStatus) =>
    tasks.filter((task) => task.status === status)

  return (
    <DndContext
      sensors={sensors}
      collisionDetection={closestCorners}
      onDragStart={handleDragStart}
      onDragOver={handleDragOver}
      onDragEnd={handleDragEnd}
    >
      <div className="flex gap-4 h-full overflow-x-auto p-4">
        {COLUMNS.map((status) => {
          const columnTasks = getTasksByStatus(status)
          return (
            <BoardColumn key={status} status={status}>
              <SortableContext
                items={columnTasks.map((t) => t.id)}
                strategy={verticalListSortingStrategy}
              >
                {columnTasks.map((task) => (
                  <BoardTaskCard key={task.id} task={task} />
                ))}
              </SortableContext>
              {columnTasks.length === 0 && (
                <div className="text-center py-8 text-muted-foreground text-sm">
                  No tasks
                </div>
              )}
            </BoardColumn>
          )
        })}
      </div>

      <DragOverlay>
        {activeTask && <BoardTaskCard task={activeTask} isDragging />}
      </DragOverlay>
    </DndContext>
  )
}
```

Create web/src/app/(dashboard)/projects/[projectId]/board/page.tsx:
```typescript
import { apiClient } from '@/lib/api'
import { KanbanBoard } from '@/components/board/kanban-board'
import type { Task } from '@/types/task'
import type { PaginatedResponse } from '@/types/api'

export default async function BoardPage({
  params,
}: {
  params: Promise<{ projectId: string }>
}) {
  const { projectId } = await params

  // Fetch all top-level tasks for the project
  const response = await apiClient<PaginatedResponse<Task>>(
    `/tasks?projectId=${projectId}&limit=100&parentTaskId=null`
  )

  return (
    <div className="h-full flex flex-col">
      <div className="flex items-center justify-between mb-4">
        <h1 className="text-2xl font-bold">Board</h1>
        {/* TODO: Add create task button */}
      </div>
      <div className="flex-1 -mx-6 -mb-6">
        <KanbanBoard initialTasks={response.data} />
      </div>
    </div>
  )
}
```
  </action>
  <verify>
```bash
cd /Users/dio/RnD/web
test -f src/components/board/kanban-board.tsx && echo "KanbanBoard OK"
test -f src/app/\\(dashboard\\)/projects/\\[projectId\\]/board/page.tsx && echo "Board page OK"
grep -q "DndContext" src/components/board/kanban-board.tsx && echo "DndContext OK"
grep -q "handleDragEnd" src/components/board/kanban-board.tsx && echo "Drag handling OK"
grep -q "updateTask" src/components/board/kanban-board.tsx && echo "Update on drag OK"
```
  </verify>
  <done>KanbanBoard component with DnD context, three columns, drag-drop updates status via optimistic hook, board page fetches and renders</done>
</task>

</tasks>

<verification>
After completing all tasks:
1. Navigate to /projects/[id]/board
2. See three columns: To Do, In Progress, Done
3. Tasks appear in their respective columns based on status
4. Drag a task from one column to another
5. Task immediately appears in new column (optimistic)
6. Refresh page - task remains in new status (persisted)
7. Keyboard navigation works for accessibility
</verification>

<success_criteria>
- Kanban board displays tasks in three status columns
- Tasks can be dragged between columns
- Status updates optimistically (instant UI feedback)
- Status persists on page refresh (API call succeeded)
- Drag overlay shows card while dragging
- Keyboard navigation supported via dnd-kit
- Empty columns show placeholder text
</success_criteria>

<output>
After completion, create `.planning/phases/07-web-ui-analytics/07-04-SUMMARY.md`
</output>
