---
phase: 07-web-ui-analytics
plan: 03
type: execute
wave: 2
depends_on: ["07-01", "07-02"]
files_modified:
  - web/src/app/(dashboard)/layout.tsx
  - web/src/app/(dashboard)/page.tsx
  - web/src/app/(dashboard)/projects/[projectId]/page.tsx
  - web/src/components/common/sidebar.tsx
  - web/src/components/common/header.tsx
  - web/src/components/common/project-selector.tsx
  - web/src/components/common/health-card.tsx
  - web/src/components/common/user-menu.tsx
autonomous: true
user_setup: []

must_haves:
  truths:
    - "User sees dashboard layout with sidebar and header after login"
    - "User can select a project from dropdown in header"
    - "Project overview shows health indicators with colored dots"
    - "User can log out via user menu"
  artifacts:
    - path: "web/src/app/(dashboard)/layout.tsx"
      provides: "Dashboard layout with sidebar and header"
      contains: "DashboardLayout"
    - path: "web/src/components/common/sidebar.tsx"
      provides: "Navigation sidebar"
      exports: ["Sidebar"]
    - path: "web/src/components/common/project-selector.tsx"
      provides: "Project dropdown in header"
      exports: ["ProjectSelector"]
    - path: "web/src/components/common/health-card.tsx"
      provides: "Health indicator card component"
      exports: ["HealthCard"]
  key_links:
    - from: "web/src/app/(dashboard)/layout.tsx"
      to: "web/src/components/common/sidebar.tsx"
      via: "component import"
      pattern: "import.*Sidebar.*from"
    - from: "web/src/components/common/project-selector.tsx"
      to: "/api/v1/projects"
      via: "API fetch"
      pattern: "fetch.*projects"
    - from: "web/src/app/(dashboard)/projects/[projectId]/page.tsx"
      to: "web/src/components/common/health-card.tsx"
      via: "component import"
      pattern: "import.*HealthCard"
---

<objective>
Build dashboard layout with sidebar navigation, header with project selector, and project overview page with health indicators.

Purpose: Provide the main UI shell that users see after login, with navigation and project context selection.
Output: Complete dashboard layout with sidebar, header, project selector dropdown, and project overview page showing health metrics.
</objective>

<execution_context>
@/Users/dio/.claude/get-shit-done/workflows/execute-plan.md
@/Users/dio/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/07-web-ui-analytics/07-RESEARCH.md
@.planning/phases/07-web-ui-analytics/07-01-SUMMARY.md
@.planning/phases/07-web-ui-analytics/07-02-SUMMARY.md
@src/features/projects/projects.routes.ts
@src/features/metrics/metrics.routes.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create dashboard layout with sidebar and header</name>
  <files>
    - web/src/app/(dashboard)/layout.tsx
    - web/src/components/common/sidebar.tsx
    - web/src/components/common/header.tsx
    - web/src/components/common/user-menu.tsx
  </files>
  <action>
Create the main dashboard layout that wraps all authenticated pages.

Create web/src/components/common/sidebar.tsx:
```typescript
'use client'

import Link from 'next/link'
import { usePathname } from 'next/navigation'
import { cn } from '@/lib/utils'
import {
  LayoutDashboard,
  KanbanSquare,
  List,
  BarChart3,
  Settings,
} from 'lucide-react'

interface SidebarProps {
  projectId?: string
}

export function Sidebar({ projectId }: SidebarProps) {
  const pathname = usePathname()

  const navigation = projectId
    ? [
        { name: 'Overview', href: `/projects/${projectId}`, icon: LayoutDashboard },
        { name: 'Board', href: `/projects/${projectId}/board`, icon: KanbanSquare },
        { name: 'List', href: `/projects/${projectId}/list`, icon: List },
        { name: 'Analytics', href: `/projects/${projectId}/analytics`, icon: BarChart3 },
      ]
    : [
        { name: 'Dashboard', href: '/', icon: LayoutDashboard },
      ]

  return (
    <aside className="w-64 border-r bg-card h-screen flex flex-col">
      <div className="p-6">
        <h1 className="text-xl font-bold">BlockBot</h1>
      </div>
      <nav className="flex-1 px-4 space-y-1">
        {navigation.map((item) => {
          const isActive = pathname === item.href
          return (
            <Link
              key={item.name}
              href={item.href}
              className={cn(
                'flex items-center gap-3 px-3 py-2 rounded-md text-sm font-medium transition-colors',
                isActive
                  ? 'bg-primary text-primary-foreground'
                  : 'text-muted-foreground hover:bg-muted hover:text-foreground'
              )}
            >
              <item.icon className="h-4 w-4" />
              {item.name}
            </Link>
          )
        })}
      </nav>
      <div className="p-4 border-t">
        <Link
          href="/settings"
          className="flex items-center gap-3 px-3 py-2 rounded-md text-sm font-medium text-muted-foreground hover:bg-muted hover:text-foreground"
        >
          <Settings className="h-4 w-4" />
          Settings
        </Link>
      </div>
    </aside>
  )
}
```

Create web/src/components/common/header.tsx with project selector placeholder and user menu.

Create web/src/components/common/user-menu.tsx:
```typescript
'use client'

import { useRouter } from 'next/navigation'
import { LogOut, User } from 'lucide-react'
import {
  DropdownMenu,
  DropdownMenuContent,
  DropdownMenuItem,
  DropdownMenuSeparator,
  DropdownMenuTrigger,
} from '@/components/ui/dropdown-menu'
import { Button } from '@/components/ui/button'

interface UserMenuProps {
  userEmail?: string
}

export function UserMenu({ userEmail }: UserMenuProps) {
  const router = useRouter()

  const handleLogout = async () => {
    try {
      await fetch('/api/auth/logout', { method: 'POST' })
      router.push('/login')
      router.refresh()
    } catch (error) {
      console.error('Logout failed:', error)
    }
  }

  return (
    <DropdownMenu>
      <DropdownMenuTrigger asChild>
        <Button variant="ghost" size="sm" className="gap-2">
          <User className="h-4 w-4" />
          <span className="hidden sm:inline">{userEmail || 'Account'}</span>
        </Button>
      </DropdownMenuTrigger>
      <DropdownMenuContent align="end">
        {userEmail && (
          <>
            <div className="px-2 py-1.5 text-sm text-muted-foreground">{userEmail}</div>
            <DropdownMenuSeparator />
          </>
        )}
        <DropdownMenuItem onClick={handleLogout} className="text-destructive cursor-pointer">
          <LogOut className="h-4 w-4 mr-2" />
          Log out
        </DropdownMenuItem>
      </DropdownMenuContent>
    </DropdownMenu>
  )
}
```

The handleLogout function:
1. Calls POST /api/auth/logout to clear cookies
2. Redirects to /login using router.push
3. Calls router.refresh() to clear client-side cache

Create web/src/app/(dashboard)/layout.tsx:
```typescript
import { cookies } from 'next/headers'
import { redirect } from 'next/navigation'
import { Sidebar } from '@/components/common/sidebar'
import { Header } from '@/components/common/header'

export default async function DashboardLayout({
  children,
  params,
}: {
  children: React.ReactNode
  params: Promise<{ projectId?: string }>
}) {
  const cookieStore = await cookies()
  const token = cookieStore.get('access_token')

  // Double-check auth (middleware should catch this first)
  if (!token) {
    redirect('/login')
  }

  const resolvedParams = await params

  return (
    <div className="flex h-screen">
      <Sidebar projectId={resolvedParams.projectId} />
      <div className="flex-1 flex flex-col overflow-hidden">
        <Header />
        <main className="flex-1 overflow-y-auto p-6 bg-background">
          {children}
        </main>
      </div>
    </div>
  )
}
```

Install lucide-react for icons:
```bash
cd /Users/dio/RnD/web && npm install lucide-react
```
  </action>
  <verify>
```bash
cd /Users/dio/RnD/web
test -f src/app/\\(dashboard\\)/layout.tsx && echo "Dashboard layout OK"
test -f src/components/common/sidebar.tsx && echo "Sidebar OK"
test -f src/components/common/header.tsx && echo "Header OK"
grep -q "lucide-react" package.json && echo "Icons installed"
```
  </verify>
  <done>Dashboard layout with sidebar navigation (Overview, Board, List, Analytics, Settings), header, and user menu with logout</done>
</task>

<task type="auto">
  <name>Task 2: Create project selector and dashboard home page</name>
  <files>
    - web/src/components/common/project-selector.tsx
    - web/src/app/(dashboard)/page.tsx
    - web/src/hooks/use-projects.ts
  </files>
  <action>
Create the project selector dropdown and the dashboard home page showing project list.

Create web/src/hooks/use-projects.ts:
```typescript
'use client'

import { useState, useEffect } from 'react'
import type { Project } from '@/types/project'

export function useProjects() {
  const [projects, setProjects] = useState<Project[]>([])
  const [loading, setLoading] = useState(true)
  const [error, setError] = useState<Error | null>(null)

  useEffect(() => {
    async function fetchProjects() {
      try {
        const response = await fetch('/api/v1/projects', {
          credentials: 'include',
        })
        if (!response.ok) throw new Error('Failed to fetch projects')
        const data = await response.json()
        setProjects(data)
      } catch (err) {
        setError(err instanceof Error ? err : new Error('Unknown error'))
      } finally {
        setLoading(false)
      }
    }
    fetchProjects()
  }, [])

  return { projects, loading, error }
}
```

Create web/src/components/common/project-selector.tsx:
```typescript
'use client'

import { useRouter, useParams } from 'next/navigation'
import {
  Select,
  SelectContent,
  SelectItem,
  SelectTrigger,
  SelectValue,
} from '@/components/ui/select'
import { useProjects } from '@/hooks/use-projects'
import { Skeleton } from '@/components/ui/skeleton'

export function ProjectSelector() {
  const router = useRouter()
  const params = useParams()
  const currentProjectId = params.projectId as string | undefined
  const { projects, loading } = useProjects()

  if (loading) {
    return <Skeleton className="h-9 w-48" />
  }

  const handleChange = (projectId: string) => {
    router.push(`/projects/${projectId}`)
  }

  return (
    <Select value={currentProjectId} onValueChange={handleChange}>
      <SelectTrigger className="w-48">
        <SelectValue placeholder="Select project" />
      </SelectTrigger>
      <SelectContent>
        {projects.map((project) => (
          <SelectItem key={project.id} value={project.id}>
            {project.name}
          </SelectItem>
        ))}
      </SelectContent>
    </Select>
  )
}
```

Create web/src/app/(dashboard)/page.tsx:
```typescript
import { cookies } from 'next/headers'
import Link from 'next/link'
import { apiClient } from '@/lib/api'
import { Card, CardHeader, CardTitle, CardDescription } from '@/components/ui/card'
import type { Project } from '@/types/project'

export default async function DashboardPage() {
  const projects = await apiClient<Project[]>('/projects')

  if (projects.length === 0) {
    return (
      <div className="space-y-6">
        <h1 className="text-3xl font-bold">Welcome to BlockBot</h1>
        <p className="text-muted-foreground">
          You don't have any projects yet. Create one to get started.
        </p>
      </div>
    )
  }

  return (
    <div className="space-y-6">
      <h1 className="text-3xl font-bold">Your Projects</h1>
      <div className="grid gap-4 md:grid-cols-2 lg:grid-cols-3">
        {projects.map((project) => (
          <Link key={project.id} href={`/projects/${project.id}`}>
            <Card className="hover:border-primary transition-colors cursor-pointer">
              <CardHeader>
                <CardTitle>{project.name}</CardTitle>
                <CardDescription>
                  {project.description || 'No description'}
                </CardDescription>
              </CardHeader>
            </Card>
          </Link>
        ))}
      </div>
    </div>
  )
}
```

Update Header component to include ProjectSelector when on a project route.
  </action>
  <verify>
```bash
cd /Users/dio/RnD/web
test -f src/components/common/project-selector.tsx && echo "Project selector OK"
test -f src/app/\\(dashboard\\)/page.tsx && echo "Dashboard page OK"
test -f src/hooks/use-projects.ts && echo "Projects hook OK"
grep -q "Select" src/components/common/project-selector.tsx && echo "Using Select component"
```
  </verify>
  <done>Project selector dropdown in header, dashboard home shows project cards, clicking navigates to project</done>
</task>

<task type="auto">
  <name>Task 3: Create project overview page with health indicators</name>
  <files>
    - web/src/app/(dashboard)/projects/[projectId]/page.tsx
    - web/src/app/(dashboard)/projects/[projectId]/layout.tsx
    - web/src/components/common/health-card.tsx
  </files>
  <action>
Create the project overview page showing health metrics and summary cards.

Create web/src/components/common/health-card.tsx:
```typescript
import { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card'
import { cn } from '@/lib/utils'
import type { HealthLevel } from '@/types/analytics'

interface HealthCardProps {
  title: string
  value: string | number
  health: HealthLevel
  description?: string
  trend?: 'up' | 'down' | 'neutral'
}

const healthColors: Record<HealthLevel, string> = {
  healthy: 'bg-green-500',
  warning: 'bg-yellow-500',
  critical: 'bg-red-500',
}

export function HealthCard({ title, value, health, description, trend }: HealthCardProps) {
  return (
    <Card>
      <CardHeader className="flex flex-row items-center justify-between pb-2">
        <CardTitle className="text-sm font-medium text-muted-foreground">
          {title}
        </CardTitle>
        <div className={cn('h-3 w-3 rounded-full', healthColors[health])} />
      </CardHeader>
      <CardContent>
        <div className="flex items-baseline gap-2">
          <span className="text-2xl font-bold">{value}</span>
          {trend && (
            <span className={cn(
              'text-xs',
              trend === 'up' && 'text-green-500',
              trend === 'down' && 'text-red-500',
              trend === 'neutral' && 'text-muted-foreground'
            )}>
              {trend === 'up' && '↑'}
              {trend === 'down' && '↓'}
              {trend === 'neutral' && '→'}
            </span>
          )}
        </div>
        {description && (
          <p className="text-xs text-muted-foreground mt-1">{description}</p>
        )}
      </CardContent>
    </Card>
  )
}
```

Create web/src/app/(dashboard)/projects/[projectId]/layout.tsx:
```typescript
import { Sidebar } from '@/components/common/sidebar'
import { Header } from '@/components/common/header'

export default async function ProjectLayout({
  children,
  params,
}: {
  children: React.ReactNode
  params: Promise<{ projectId: string }>
}) {
  const { projectId } = await params

  return (
    <div className="flex h-screen">
      <Sidebar projectId={projectId} />
      <div className="flex-1 flex flex-col overflow-hidden">
        <Header projectId={projectId} />
        <main className="flex-1 overflow-y-auto p-6 bg-background">
          {children}
        </main>
      </div>
    </div>
  )
}
```

Create web/src/app/(dashboard)/projects/[projectId]/page.tsx:
```typescript
import { apiClient } from '@/lib/api'
import { HealthCard } from '@/components/common/health-card'
import type { Project } from '@/types/project'
import type { OutputMetrics, VelocityPeriod } from '@/types/analytics'
import type { ApiResponse } from '@/types/api'

// Helper to compute health level from metrics
function computeHealth(current: number, previous: number): 'healthy' | 'warning' | 'critical' {
  if (previous === 0) return current > 0 ? 'healthy' : 'warning'
  const change = ((current - previous) / previous) * 100
  if (change >= -10) return 'healthy'
  if (change >= -30) return 'warning'
  return 'critical'
}

export default async function ProjectOverviewPage({
  params,
}: {
  params: Promise<{ projectId: string }>
}) {
  const { projectId } = await params

  // Fetch project and metrics in parallel
  const [project, velocityResponse] = await Promise.all([
    apiClient<Project>(`/projects/${projectId}`),
    apiClient<ApiResponse<VelocityPeriod[]>>(`/metrics/velocity?projectId=${projectId}&periodDays=7&numPeriods=4`),
  ])

  const velocity = velocityResponse.data
  const currentVelocity = velocity[velocity.length - 1]?.velocity ?? 0
  const previousVelocity = velocity[velocity.length - 2]?.velocity ?? 0
  const velocityHealth = computeHealth(currentVelocity, previousVelocity)

  // Get task counts for today
  const today = new Date().toISOString().split('T')[0]
  const weekAgo = new Date(Date.now() - 7 * 24 * 60 * 60 * 1000).toISOString().split('T')[0]

  const outputResponse = await apiClient<ApiResponse<OutputMetrics>>(
    `/metrics/output?projectId=${projectId}&startDate=${weekAgo}&endDate=${today}`
  )
  const output = outputResponse.data

  return (
    <div className="space-y-6">
      <div>
        <h1 className="text-3xl font-bold">{project.name}</h1>
        {project.description && (
          <p className="text-muted-foreground mt-1">{project.description}</p>
        )}
      </div>

      <div className="grid gap-4 md:grid-cols-2 lg:grid-cols-4">
        <HealthCard
          title="Velocity (7d)"
          value={currentVelocity}
          health={velocityHealth}
          description="Tasks completed this week"
          trend={currentVelocity > previousVelocity ? 'up' : currentVelocity < previousVelocity ? 'down' : 'neutral'}
        />
        <HealthCard
          title="Tasks Completed"
          value={output.totals.tasksCompleted}
          health={output.totals.tasksCompleted > 0 ? 'healthy' : 'warning'}
          description="Last 7 days"
        />
        <HealthCard
          title="Deliverables"
          value={output.totals.deliverablesCompleted}
          health={output.totals.deliverablesCompleted > 0 ? 'healthy' : 'warning'}
          description="Last 7 days"
        />
        <HealthCard
          title="Active Members"
          value={output.byUser.length}
          health={output.byUser.length > 0 ? 'healthy' : 'warning'}
          description="Contributors this week"
        />
      </div>

      {/* Quick links to views */}
      <div className="grid gap-4 md:grid-cols-3">
        <a href={`/projects/${projectId}/board`} className="block p-4 border rounded-lg hover:border-primary transition-colors">
          <h3 className="font-semibold">Board View</h3>
          <p className="text-sm text-muted-foreground">Kanban board with drag-and-drop</p>
        </a>
        <a href={`/projects/${projectId}/list`} className="block p-4 border rounded-lg hover:border-primary transition-colors">
          <h3 className="font-semibold">List View</h3>
          <p className="text-sm text-muted-foreground">Filterable task list</p>
        </a>
        <a href={`/projects/${projectId}/analytics`} className="block p-4 border rounded-lg hover:border-primary transition-colors">
          <h3 className="font-semibold">Analytics</h3>
          <p className="text-sm text-muted-foreground">Charts and metrics</p>
        </a>
      </div>
    </div>
  )
}
```
  </action>
  <verify>
```bash
cd /Users/dio/RnD/web
test -f src/components/common/health-card.tsx && echo "Health card OK"
test -f src/app/\\(dashboard\\)/projects/\\[projectId\\]/page.tsx && echo "Project page OK"
test -f src/app/\\(dashboard\\)/projects/\\[projectId\\]/layout.tsx && echo "Project layout OK"
grep -q "HealthCard" src/app/\\(dashboard\\)/projects/\\[projectId\\]/page.tsx && echo "Using HealthCard"
```
  </verify>
  <done>Project overview page with health indicator cards (velocity, tasks, deliverables, members), quick links to board/list/analytics</done>
</task>

</tasks>

<verification>
After completing all tasks:
1. `npm run dev` and navigate to / - shows project list
2. Click a project - navigates to /projects/[id] showing overview
3. Health cards display with colored dots
4. Sidebar navigation updates based on current project
5. Project selector in header allows switching projects
6. User menu shows logout option
</verification>

<success_criteria>
- Dashboard layout with sidebar and header renders correctly
- Sidebar shows context-aware navigation (dashboard vs project views)
- Project selector dropdown shows all user's projects
- Project overview page displays health cards with metrics from API
- Health indicators show green/yellow/red based on metric values
- User can log out via user menu
</success_criteria>

<output>
After completion, create `.planning/phases/07-web-ui-analytics/07-03-SUMMARY.md`
</output>
