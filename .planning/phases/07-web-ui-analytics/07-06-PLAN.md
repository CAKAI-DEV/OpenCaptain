---
phase: 07-web-ui-analytics
plan: 06
type: execute
wave: 3
depends_on: ["07-03", "07-04"]
files_modified:
  - web/src/app/(dashboard)/projects/[projectId]/analytics/page.tsx
  - web/src/components/charts/velocity-chart.tsx
  - web/src/components/charts/burndown-chart.tsx
  - web/src/components/charts/output-chart.tsx
  - web/src/components/charts/date-range-picker.tsx
  - web/src/components/analytics/personal-stats.tsx
  - web/src/components/analytics/squad-stats.tsx
  - web/src/components/analytics/project-stats.tsx
autonomous: true
user_setup: []

must_haves:
  truths:
    - "User can view their individual analytics (tasks completed, trends)"
    - "User can select date range to filter analytics data"
    - "Squad lead can see squad-level analytics"
    - "PM can see project-level analytics with all squads"
  artifacts:
    - path: "web/src/app/(dashboard)/projects/[projectId]/analytics/page.tsx"
      provides: "Analytics page with role-based sections"
      min_lines: 50
    - path: "web/src/components/charts/velocity-chart.tsx"
      provides: "Line chart showing velocity trend"
      exports: ["VelocityChart"]
    - path: "web/src/components/charts/output-chart.tsx"
      provides: "Bar chart showing output by user/squad"
      exports: ["OutputChart"]
    - path: "web/src/components/charts/date-range-picker.tsx"
      provides: "Date range selector with presets"
      exports: ["DateRangePicker"]
  key_links:
    - from: "web/src/components/charts/velocity-chart.tsx"
      to: "recharts"
      via: "chart imports"
      pattern: "import.*from.*recharts"
    - from: "web/src/app/(dashboard)/projects/[projectId]/analytics/page.tsx"
      to: "/api/v1/metrics"
      via: "API fetch"
      pattern: "apiClient.*metrics"
---

<objective>
Build analytics dashboards with charts for individual, squad, and project-level metrics using Recharts.

Purpose: Provide visibility into productivity trends and output metrics at all organizational levels.
Output: Analytics page with velocity charts, output charts, burndown, and date range selection.
</objective>

<execution_context>
@/Users/dio/.claude/get-shit-done/workflows/execute-plan.md
@/Users/dio/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/07-web-ui-analytics/07-RESEARCH.md
@.planning/phases/07-web-ui-analytics/07-03-SUMMARY.md
@src/features/metrics/metrics.routes.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install Recharts and create chart components</name>
  <files>
    - web/package.json
    - web/src/components/charts/velocity-chart.tsx
    - web/src/components/charts/burndown-chart.tsx
    - web/src/components/charts/output-chart.tsx
  </files>
  <action>
Install Recharts and create the chart wrapper components.

```bash
cd /Users/dio/RnD/web
npm install recharts
```

Create web/src/components/charts/velocity-chart.tsx:
```typescript
'use client'

import {
  LineChart,
  Line,
  XAxis,
  YAxis,
  CartesianGrid,
  Tooltip,
  ResponsiveContainer,
} from 'recharts'
import { Card, CardContent, CardHeader, CardTitle, CardDescription } from '@/components/ui/card'
import type { VelocityPeriod } from '@/types/analytics'

interface VelocityChartProps {
  data: VelocityPeriod[]
  title?: string
  description?: string
}

export function VelocityChart({
  data,
  title = 'Velocity Trend',
  description = 'Tasks completed per period',
}: VelocityChartProps) {
  const formattedData = data.map((d) => ({
    ...d,
    label: new Date(d.periodStart).toLocaleDateString('en-US', {
      month: 'short',
      day: 'numeric',
    }),
  }))

  return (
    <Card>
      <CardHeader>
        <CardTitle>{title}</CardTitle>
        <CardDescription>{description}</CardDescription>
      </CardHeader>
      <CardContent>
        <div className="h-[300px]">
          <ResponsiveContainer width="100%" height="100%">
            <LineChart data={formattedData}>
              <CartesianGrid strokeDasharray="3 3" className="stroke-muted" />
              <XAxis
                dataKey="label"
                className="text-xs"
                tick={{ fill: 'hsl(var(--muted-foreground))' }}
              />
              <YAxis
                className="text-xs"
                tick={{ fill: 'hsl(var(--muted-foreground))' }}
                allowDecimals={false}
              />
              <Tooltip
                contentStyle={{
                  backgroundColor: 'hsl(var(--card))',
                  border: '1px solid hsl(var(--border))',
                  borderRadius: '8px',
                }}
              />
              <Line
                type="monotone"
                dataKey="velocity"
                stroke="hsl(var(--primary))"
                strokeWidth={2}
                dot={{ fill: 'hsl(var(--primary))', r: 4 }}
                activeDot={{ r: 6 }}
              />
            </LineChart>
          </ResponsiveContainer>
        </div>
      </CardContent>
    </Card>
  )
}
```

Create web/src/components/charts/burndown-chart.tsx:
```typescript
'use client'

import {
  AreaChart,
  Area,
  XAxis,
  YAxis,
  CartesianGrid,
  Tooltip,
  ResponsiveContainer,
} from 'recharts'
import { Card, CardContent, CardHeader, CardTitle, CardDescription } from '@/components/ui/card'
import type { BurndownPoint } from '@/types/analytics'

interface BurndownChartProps {
  data: BurndownPoint[]
  title?: string
  description?: string
}

export function BurndownChart({
  data,
  title = 'Burndown',
  description = 'Remaining vs completed work',
}: BurndownChartProps) {
  const formattedData = data.map((d) => ({
    ...d,
    label: new Date(d.date).toLocaleDateString('en-US', {
      month: 'short',
      day: 'numeric',
    }),
  }))

  return (
    <Card>
      <CardHeader>
        <CardTitle>{title}</CardTitle>
        <CardDescription>{description}</CardDescription>
      </CardHeader>
      <CardContent>
        <div className="h-[300px]">
          <ResponsiveContainer width="100%" height="100%">
            <AreaChart data={formattedData}>
              <CartesianGrid strokeDasharray="3 3" className="stroke-muted" />
              <XAxis
                dataKey="label"
                className="text-xs"
                tick={{ fill: 'hsl(var(--muted-foreground))' }}
              />
              <YAxis
                className="text-xs"
                tick={{ fill: 'hsl(var(--muted-foreground))' }}
                allowDecimals={false}
              />
              <Tooltip
                contentStyle={{
                  backgroundColor: 'hsl(var(--card))',
                  border: '1px solid hsl(var(--border))',
                  borderRadius: '8px',
                }}
              />
              <Area
                type="monotone"
                dataKey="remaining"
                stackId="1"
                stroke="hsl(var(--destructive))"
                fill="hsl(var(--destructive) / 0.2)"
                name="Remaining"
              />
              <Area
                type="monotone"
                dataKey="completed"
                stackId="2"
                stroke="hsl(var(--primary))"
                fill="hsl(var(--primary) / 0.2)"
                name="Completed"
              />
            </AreaChart>
          </ResponsiveContainer>
        </div>
      </CardContent>
    </Card>
  )
}
```

Create web/src/components/charts/output-chart.tsx:
```typescript
'use client'

import {
  BarChart,
  Bar,
  XAxis,
  YAxis,
  CartesianGrid,
  Tooltip,
  ResponsiveContainer,
  Legend,
} from 'recharts'
import { Card, CardContent, CardHeader, CardTitle, CardDescription } from '@/components/ui/card'

interface OutputData {
  name: string
  tasks: number
  deliverables: number
}

interface OutputChartProps {
  data: OutputData[]
  title?: string
  description?: string
}

export function OutputChart({
  data,
  title = 'Output',
  description = 'Tasks and deliverables completed',
}: OutputChartProps) {
  return (
    <Card>
      <CardHeader>
        <CardTitle>{title}</CardTitle>
        <CardDescription>{description}</CardDescription>
      </CardHeader>
      <CardContent>
        <div className="h-[300px]">
          <ResponsiveContainer width="100%" height="100%">
            <BarChart data={data}>
              <CartesianGrid strokeDasharray="3 3" className="stroke-muted" />
              <XAxis
                dataKey="name"
                className="text-xs"
                tick={{ fill: 'hsl(var(--muted-foreground))' }}
              />
              <YAxis
                className="text-xs"
                tick={{ fill: 'hsl(var(--muted-foreground))' }}
                allowDecimals={false}
              />
              <Tooltip
                contentStyle={{
                  backgroundColor: 'hsl(var(--card))',
                  border: '1px solid hsl(var(--border))',
                  borderRadius: '8px',
                }}
              />
              <Legend />
              <Bar
                dataKey="tasks"
                fill="hsl(var(--primary))"
                name="Tasks"
                radius={[4, 4, 0, 0]}
              />
              <Bar
                dataKey="deliverables"
                fill="hsl(var(--secondary))"
                name="Deliverables"
                radius={[4, 4, 0, 0]}
              />
            </BarChart>
          </ResponsiveContainer>
        </div>
      </CardContent>
    </Card>
  )
}
```
  </action>
  <verify>
```bash
cd /Users/dio/RnD/web
grep -q "recharts" package.json && echo "Recharts installed"
test -f src/components/charts/velocity-chart.tsx && echo "Velocity chart OK"
test -f src/components/charts/burndown-chart.tsx && echo "Burndown chart OK"
test -f src/components/charts/output-chart.tsx && echo "Output chart OK"
grep -q "ResponsiveContainer" src/components/charts/velocity-chart.tsx && echo "Using Recharts"
```
  </verify>
  <done>Recharts installed, VelocityChart (line), BurndownChart (area), OutputChart (bar) components created</done>
</task>

<task type="auto">
  <name>Task 2: Create date range picker and analytics sections</name>
  <files>
    - web/src/components/charts/date-range-picker.tsx
    - web/src/components/analytics/personal-stats.tsx
    - web/src/components/analytics/squad-stats.tsx
    - web/src/components/analytics/project-stats.tsx
  </files>
  <action>
Create date range picker with presets and analytics section components.

Create web/src/components/charts/date-range-picker.tsx:
```typescript
'use client'

import { useState } from 'react'
import { useRouter, useSearchParams, usePathname } from 'next/navigation'
import { format, subDays, startOfWeek, endOfWeek, startOfMonth, endOfMonth } from 'date-fns'
import { Calendar } from '@/components/ui/calendar'
import { Button } from '@/components/ui/button'
import {
  Popover,
  PopoverContent,
  PopoverTrigger,
} from '@/components/ui/popover'
import { cn } from '@/lib/utils'
import { CalendarIcon } from 'lucide-react'
import type { DateRange } from 'react-day-picker'

const PRESETS = [
  { label: 'Last 7 days', value: '7d', days: 7 },
  { label: 'Last 30 days', value: '30d', days: 30 },
  { label: 'Last 90 days', value: '90d', days: 90 },
  { label: 'This week', value: 'week', getRange: () => ({
    from: startOfWeek(new Date()),
    to: endOfWeek(new Date()),
  })},
  { label: 'This month', value: 'month', getRange: () => ({
    from: startOfMonth(new Date()),
    to: endOfMonth(new Date()),
  })},
]

interface DateRangePickerProps {
  className?: string
}

export function DateRangePicker({ className }: DateRangePickerProps) {
  const router = useRouter()
  const pathname = usePathname()
  const searchParams = useSearchParams()

  const fromParam = searchParams.get('from')
  const toParam = searchParams.get('to')

  const [date, setDate] = useState<DateRange | undefined>(() => {
    if (fromParam && toParam) {
      return {
        from: new Date(fromParam),
        to: new Date(toParam),
      }
    }
    // Default to last 30 days
    return {
      from: subDays(new Date(), 30),
      to: new Date(),
    }
  })

  const updateRange = (range: DateRange | undefined) => {
    setDate(range)
    if (range?.from && range?.to) {
      const params = new URLSearchParams(searchParams.toString())
      params.set('from', format(range.from, 'yyyy-MM-dd'))
      params.set('to', format(range.to, 'yyyy-MM-dd'))
      router.push(`${pathname}?${params.toString()}`)
    }
  }

  const applyPreset = (preset: typeof PRESETS[number]) => {
    let range: DateRange
    if ('days' in preset) {
      range = {
        from: subDays(new Date(), preset.days),
        to: new Date(),
      }
    } else if (preset.getRange) {
      range = preset.getRange()
    } else {
      return
    }
    updateRange(range)
  }

  return (
    <div className={cn('flex items-center gap-2', className)}>
      <div className="flex gap-1">
        {PRESETS.slice(0, 3).map((preset) => (
          <Button
            key={preset.value}
            variant="outline"
            size="sm"
            onClick={() => applyPreset(preset)}
          >
            {preset.label}
          </Button>
        ))}
      </div>

      <Popover>
        <PopoverTrigger asChild>
          <Button
            variant="outline"
            size="sm"
            className={cn(
              'justify-start text-left font-normal',
              !date && 'text-muted-foreground'
            )}
          >
            <CalendarIcon className="mr-2 h-4 w-4" />
            {date?.from ? (
              date.to ? (
                <>
                  {format(date.from, 'MMM d')} - {format(date.to, 'MMM d')}
                </>
              ) : (
                format(date.from, 'MMM d, yyyy')
              )
            ) : (
              <span>Pick a date</span>
            )}
          </Button>
        </PopoverTrigger>
        <PopoverContent className="w-auto p-0" align="start">
          <Calendar
            initialFocus
            mode="range"
            defaultMonth={date?.from}
            selected={date}
            onSelect={updateRange}
            numberOfMonths={2}
          />
        </PopoverContent>
      </Popover>
    </div>
  )
}
```

Create web/src/components/analytics/personal-stats.tsx:
```typescript
import { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card'
import type { PersonalMetrics } from '@/types/analytics'

interface PersonalStatsProps {
  metrics: PersonalMetrics
}

export function PersonalStats({ metrics }: PersonalStatsProps) {
  return (
    <div className="space-y-4">
      <h2 className="text-lg font-semibold">Your Performance</h2>
      <div className="grid gap-4 md:grid-cols-2 lg:grid-cols-4">
        <Card>
          <CardHeader className="pb-2">
            <CardTitle className="text-sm font-medium text-muted-foreground">
              Tasks Completed
            </CardTitle>
          </CardHeader>
          <CardContent>
            <div className="text-2xl font-bold">{metrics.tasksCompleted}</div>
          </CardContent>
        </Card>

        <Card>
          <CardHeader className="pb-2">
            <CardTitle className="text-sm font-medium text-muted-foreground">
              Deliverables
            </CardTitle>
          </CardHeader>
          <CardContent>
            <div className="text-2xl font-bold">{metrics.deliverablesCompleted}</div>
          </CardContent>
        </Card>

        <Card>
          <CardHeader className="pb-2">
            <CardTitle className="text-sm font-medium text-muted-foreground">
              High Priority
            </CardTitle>
          </CardHeader>
          <CardContent>
            <div className="text-2xl font-bold">
              {(metrics.tasksByPriority?.high ?? 0) + (metrics.tasksByPriority?.urgent ?? 0)}
            </div>
          </CardContent>
        </Card>

        <Card>
          <CardHeader className="pb-2">
            <CardTitle className="text-sm font-medium text-muted-foreground">
              Avg. Completion
            </CardTitle>
          </CardHeader>
          <CardContent>
            <div className="text-2xl font-bold">
              {metrics.averageCompletionTime
                ? `${Math.round(metrics.averageCompletionTime / (24 * 60 * 60 * 1000))}d`
                : '-'}
            </div>
          </CardContent>
        </Card>
      </div>
    </div>
  )
}
```

Create similar squad-stats.tsx and project-stats.tsx with appropriate metrics displays (output by user/squad, totals).
  </action>
  <verify>
```bash
cd /Users/dio/RnD/web
test -f src/components/charts/date-range-picker.tsx && echo "Date picker OK"
test -f src/components/analytics/personal-stats.tsx && echo "Personal stats OK"
grep -q "Calendar" src/components/charts/date-range-picker.tsx && echo "Using Calendar"
grep -q "useSearchParams" src/components/charts/date-range-picker.tsx && echo "URL params OK"
```
  </verify>
  <done>DateRangePicker with presets (7d/30d/90d) and custom range, PersonalStats/SquadStats/ProjectStats section components</done>
</task>

<task type="auto">
  <name>Task 3: Create analytics page with role-based sections</name>
  <files>
    - web/src/app/(dashboard)/projects/[projectId]/analytics/page.tsx
  </files>
  <action>
Create the analytics page that fetches metrics and displays appropriate sections based on user role.

Create web/src/app/(dashboard)/projects/[projectId]/analytics/page.tsx:
```typescript
import { Suspense } from 'react'
import { format, subDays } from 'date-fns'
import { apiClient } from '@/lib/api'
import { DateRangePicker } from '@/components/charts/date-range-picker'
import { VelocityChart } from '@/components/charts/velocity-chart'
import { BurndownChart } from '@/components/charts/burndown-chart'
import { OutputChart } from '@/components/charts/output-chart'
import { PersonalStats } from '@/components/analytics/personal-stats'
import { Skeleton } from '@/components/ui/skeleton'
import type { VelocityPeriod, BurndownPoint, OutputMetrics, PersonalMetrics } from '@/types/analytics'
import type { ApiResponse } from '@/types/api'

interface AnalyticsPageProps {
  params: Promise<{ projectId: string }>
  searchParams: Promise<{
    from?: string
    to?: string
  }>
}

async function AnalyticsLoader({
  projectId,
  from,
  to,
}: {
  projectId: string
  from: string
  to: string
}) {
  // Fetch all metrics in parallel
  const [velocityRes, burndownRes, outputRes, personalRes] = await Promise.all([
    apiClient<ApiResponse<VelocityPeriod[]>>(
      `/metrics/velocity?projectId=${projectId}&periodDays=7&numPeriods=8`
    ),
    apiClient<ApiResponse<BurndownPoint[]>>(
      `/metrics/burndown?projectId=${projectId}&startDate=${from}&endDate=${to}`
    ),
    apiClient<ApiResponse<OutputMetrics>>(
      `/metrics/output?projectId=${projectId}&startDate=${from}&endDate=${to}`
    ),
    apiClient<ApiResponse<PersonalMetrics>>(
      `/metrics/personal?projectId=${projectId}&startDate=${from}&endDate=${to}`
    ),
  ])

  const velocity = velocityRes.data
  const burndown = burndownRes.data
  const output = outputRes.data
  const personal = personalRes.data

  // Transform output data for chart
  const outputByUser = output.byUser.map((u) => ({
    name: `User ${u.userId.slice(0, 8)}...`, // TODO: Fetch user names
    tasks: u.tasksCompleted,
    deliverables: u.deliverablesCompleted,
  }))

  const outputBySquad = output.bySquad.map((s) => ({
    name: `Squad ${s.squadId.slice(0, 8)}...`, // TODO: Fetch squad names
    tasks: s.tasksCompleted,
    deliverables: s.deliverablesCompleted,
  }))

  return (
    <div className="space-y-8">
      {/* Personal Stats - visible to all */}
      <PersonalStats metrics={personal} />

      {/* Charts */}
      <div className="grid gap-6 md:grid-cols-2">
        <VelocityChart
          data={velocity}
          title="Team Velocity"
          description="Tasks completed per week"
        />
        <BurndownChart
          data={burndown}
          title="Sprint Burndown"
          description="Work remaining over time"
        />
      </div>

      {/* Output by User - visible to squad leads and PMs */}
      {outputByUser.length > 0 && (
        <OutputChart
          data={outputByUser}
          title="Output by Member"
          description="Individual contribution in selected period"
        />
      )}

      {/* Output by Squad - visible to PMs */}
      {outputBySquad.length > 0 && (
        <OutputChart
          data={outputBySquad}
          title="Output by Squad"
          description="Squad performance in selected period"
        />
      )}

      {/* Totals Summary */}
      <div className="grid gap-4 md:grid-cols-3">
        <div className="p-4 border rounded-lg">
          <div className="text-sm text-muted-foreground">Total Tasks Completed</div>
          <div className="text-3xl font-bold">{output.totals.tasksCompleted}</div>
        </div>
        <div className="p-4 border rounded-lg">
          <div className="text-sm text-muted-foreground">Total Deliverables</div>
          <div className="text-3xl font-bold">{output.totals.deliverablesCompleted}</div>
        </div>
        <div className="p-4 border rounded-lg">
          <div className="text-sm text-muted-foreground">Active Contributors</div>
          <div className="text-3xl font-bold">{output.byUser.length}</div>
        </div>
      </div>
    </div>
  )
}

export default async function AnalyticsPage({ params, searchParams }: AnalyticsPageProps) {
  const { projectId } = await params
  const { from, to } = await searchParams

  // Default to last 30 days if no range specified
  const startDate = from ?? format(subDays(new Date(), 30), 'yyyy-MM-dd')
  const endDate = to ?? format(new Date(), 'yyyy-MM-dd')

  return (
    <div className="space-y-6">
      <div className="flex items-center justify-between">
        <h1 className="text-2xl font-bold">Analytics</h1>
        <DateRangePicker />
      </div>

      <Suspense
        fallback={
          <div className="space-y-6">
            <div className="grid gap-4 md:grid-cols-4">
              {[...Array(4)].map((_, i) => (
                <Skeleton key={i} className="h-24" />
              ))}
            </div>
            <div className="grid gap-6 md:grid-cols-2">
              <Skeleton className="h-[350px]" />
              <Skeleton className="h-[350px]" />
            </div>
          </div>
        }
      >
        <AnalyticsLoader
          projectId={projectId}
          from={startDate}
          to={endDate}
        />
      </Suspense>
    </div>
  )
}
```

Note: The current implementation shows all analytics to all users. Role-based visibility would require:
1. Fetching user's role in the project
2. Conditionally rendering sections based on role (member sees personal, squad lead sees squad, PM sees all)

This is a simplification for v1 - all authenticated users see all project analytics. Role-based filtering can be added later.
  </action>
  <verify>
```bash
cd /Users/dio/RnD/web
test -f src/app/\\(dashboard\\)/projects/\\[projectId\\]/analytics/page.tsx && echo "Analytics page OK"
grep -q "VelocityChart" src/app/\\(dashboard\\)/projects/\\[projectId\\]/analytics/page.tsx && echo "Using VelocityChart"
grep -q "BurndownChart" src/app/\\(dashboard\\)/projects/\\[projectId\\]/analytics/page.tsx && echo "Using BurndownChart"
grep -q "OutputChart" src/app/\\(dashboard\\)/projects/\\[projectId\\]/analytics/page.tsx && echo "Using OutputChart"
grep -q "DateRangePicker" src/app/\\(dashboard\\)/projects/\\[projectId\\]/analytics/page.tsx && echo "Date picker OK"
```
  </verify>
  <done>Analytics page fetches velocity/burndown/output/personal metrics, displays charts and stats with date range picker</done>
</task>

</tasks>

<verification>
After completing all tasks:
1. Navigate to /projects/[id]/analytics
2. See personal stats cards at top
3. See velocity line chart and burndown area chart
4. See output bar chart by user
5. See output bar chart by squad
6. Click "Last 7 days" - charts update
7. Click "Last 30 days" - charts update
8. Use custom date picker - URL updates, charts update
9. All charts render responsively on different screen sizes
</verification>

<success_criteria>
- Analytics page loads with charts from API data
- Velocity chart shows line trend over periods
- Burndown chart shows remaining/completed areas
- Output chart shows bars for tasks/deliverables by user and squad
- Date range picker has presets (7d, 30d, 90d) and custom picker
- Date range persists in URL (shareable)
- Personal stats cards show individual metrics
- Totals summary shows project-wide counts
- Loading skeletons display while data fetches
</success_criteria>

<output>
After completion, create `.planning/phases/07-web-ui-analytics/07-06-SUMMARY.md`
</output>
