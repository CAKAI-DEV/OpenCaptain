---
phase: 08-workflow-builder-integrations
plan: 04
type: execute
wave: 1
depends_on: []
files_modified:
  - src/features/messaging/messaging.task-extraction.ts
  - src/features/messaging/messaging.types.ts
  - src/features/messaging/messaging.service.ts
  - src/features/telegram/telegram.handlers.ts
  - src/features/whatsapp/whatsapp.handlers.ts
autonomous: true

must_haves:
  truths:
    - "User can create tasks via natural language in chat (e.g., 'Create a task to review the PR')"
    - "Agent shows confirmation before creating task with extracted fields"
    - "Agent auto-detects actionable items and suggests task creation"
    - "User can accept, modify, or cancel suggested tasks"
  artifacts:
    - path: "src/features/messaging/messaging.task-extraction.ts"
      provides: "LLM-based task extraction from natural language"
      exports: ["extractTaskFromMessage", "detectActionableItems"]
    - path: "src/features/messaging/messaging.service.ts"
      provides: "Updated service with task creation flow"
      contains: "handleTaskCreation"
  key_links:
    - from: "src/features/messaging/messaging.task-extraction.ts"
      to: "src/features/llm/llm.client.ts"
      via: "LLM function calling"
      pattern: "createLLMClient.*chat\\.completions"
    - from: "src/features/messaging/messaging.service.ts"
      to: "messaging.task-extraction.ts"
      via: "extractTaskFromMessage call"
      pattern: "extractTaskFromMessage"
---

<objective>
Implement natural language task creation with confirmation flow.

Purpose: Enable users to create tasks via chat with intelligent extraction (TASK-07, TASK-08).
Output: Task extraction service with confirmation UI in messaging channels.
</objective>

<execution_context>
@/Users/dio/.claude/get-shit-done/workflows/execute-plan.md
@/Users/dio/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08-workflow-builder-integrations/08-CONTEXT.md
@.planning/phases/08-workflow-builder-integrations/08-RESEARCH.md
@src/features/messaging/messaging.intents.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create task extraction service with LLM function calling</name>
  <files>
    - src/features/messaging/messaging.task-extraction.ts
    - src/features/messaging/messaging.types.ts
  </files>
  <action>
    1. Update `src/features/messaging/messaging.types.ts`:
       - Add TaskExtractionResult interface:
         - isTaskCreation: boolean
         - title: string | null
         - description: string | null
         - assigneeHint: string | null
         - dueDate: string | null (relative like "tomorrow", "next Friday")
         - priority: 'low' | 'medium' | 'high' | 'urgent' | null
         - confidence: number (0-1)
       - Add ActionableItem interface:
         - text: string (the actionable phrase)
         - suggestedTitle: string
         - confidence: number
       - Add PendingTaskConfirmation interface:
         - userId, projectId, extractedTask, expiresAt

    2. Create `src/features/messaging/messaging.task-extraction.ts`:
       - Define CREATE_TASK_FUNCTION per RESEARCH.md Pattern 8
       - Export extractTaskFromMessage(message: string):
         - Use gpt-4o-mini for speed/cost
         - Use function calling to extract task details
         - Return TaskExtractionResult with confidence score
         - Require confidence > 0.7 for task creation intent
       - Export detectActionableItems(messages: string[]):
         - Analyze recent conversation messages
         - Identify phrases that could be tasks
         - Return array of ActionableItem suggestions
         - Filter by confidence > 0.6

    CRITICAL: Never auto-create tasks. Always return extracted data for confirmation.
    Per CONTEXT.md: "Confirm before creating" and "Suggest only" modes.
  </action>
  <verify>
    Run `cd /Users/dio/RnD && bun run typecheck` - should pass without errors.
    Verify extractTaskFromMessage returns confidence score.
  </verify>
  <done>
    extractTaskFromMessage uses LLM function calling to parse task intent.
    detectActionableItems identifies potential tasks in conversation.
    Both functions return confidence scores for filtering.
  </done>
</task>

<task type="auto">
  <name>Task 2: Implement confirmation flow in messaging service</name>
  <files>
    - src/features/messaging/messaging.service.ts
    - src/shared/lib/redis/index.ts
  </files>
  <action>
    1. Add to redis/index.ts:
       - Helper for storing pending confirmations:
         - setPendingTaskConfirmation(userId, data, ttl = 300)
         - getPendingTaskConfirmation(userId)
         - deletePendingTaskConfirmation(userId)

    2. Update `src/features/messaging/messaging.service.ts`:
       - Import extractTaskFromMessage, detectActionableItems
       - Add handleTaskCreationIntent(context, extractedTask):
         - Format extracted fields into confirmation message
         - Store pending confirmation in Redis (5 min TTL)
         - Return formatted message asking user to confirm
       - Add handleTaskConfirmation(context, userResponse):
         - Get pending confirmation from Redis
         - If "yes"/"confirm": Create task via tasks.service
         - If "no"/"cancel": Delete confirmation, acknowledge
         - If has edits: Parse edits, update fields, re-confirm
       - Update processMessage:
         - After intent detection, if create_task intent detected:
           - Call extractTaskFromMessage for detailed extraction
           - Call handleTaskCreationIntent
         - Check for pending confirmation before normal processing
         - Handle confirmation responses

    3. Format confirmation message like:
       ```
       I'll create this task:

       Title: Review the PR for login feature
       Priority: High
       Due: Tomorrow

       Reply "yes" to confirm, "no" to cancel, or tell me what to change.
       ```
  </action>
  <verify>
    Run `cd /Users/dio/RnD && bun run typecheck` - should pass without errors.
    Verify pending confirmations use Redis with TTL.
  </verify>
  <done>
    Messaging service extracts task details from natural language.
    Confirmation message shows extracted fields.
    User can confirm, cancel, or request changes.
    Pending confirmations expire after 5 minutes.
  </done>
</task>

<task type="auto">
  <name>Task 3: Integrate with Telegram and WhatsApp handlers</name>
  <files>
    - src/features/telegram/telegram.handlers.ts
    - src/features/whatsapp/whatsapp.handlers.ts
  </files>
  <action>
    1. Update `src/features/telegram/telegram.handlers.ts`:
       - Add /task command that triggers task creation mode
       - Update handleTextMessage to detect task creation patterns
       - Add inline keyboard for confirmation:
         - "Confirm" button
         - "Cancel" button
         - "Edit" button (shows current fields)
       - Handle callback_query for button responses

    2. Update `src/features/whatsapp/whatsapp.handlers.ts`:
       - Add task creation trigger phrases ("create task", "add task", "new task")
       - Format confirmation as interactive message with buttons (WhatsApp supports this)
       - Handle button responses for confirmation

    3. Add auto-detection integration:
       - After extended conversation (5+ messages), call detectActionableItems
       - If actionable items found with high confidence, suggest:
         ```
         I noticed you mentioned a few things that could be tasks:
         1. "Review the PR for login feature"
         2. "Update the documentation"

         Reply with the number to create that task, or "skip" to continue.
         ```
  </action>
  <verify>
    Run `cd /Users/dio/RnD && bun run typecheck` - should pass without errors.
    Run `cd /Users/dio/RnD && bun run lint` - should pass without errors.
  </verify>
  <done>
    Telegram /task command triggers task creation.
    WhatsApp responds to "create task" phrases.
    Both channels show confirmation with buttons.
    Auto-detection suggests tasks after extended conversations.
  </done>
</task>

</tasks>

<verification>
1. `cd /Users/dio/RnD && bun run typecheck` passes
2. `cd /Users/dio/RnD && bun run lint` passes
3. extractTaskFromMessage returns structured TaskExtractionResult
4. Confirmation flow stores pending task in Redis with TTL
5. Telegram and WhatsApp handlers support task creation
</verification>

<success_criteria>
- User can say "Create a task to review the PR" and get confirmation prompt
- Agent extracts title, description, priority, due date from natural language
- Confirmation shows extracted fields and allows accept/modify/cancel
- Auto-detection suggests actionable items without creating automatically
- Build and lint pass without errors
</success_criteria>

<output>
After completion, create `.planning/phases/08-workflow-builder-integrations/08-04-SUMMARY.md`
</output>
