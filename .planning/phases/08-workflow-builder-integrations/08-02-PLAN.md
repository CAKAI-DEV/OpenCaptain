---
phase: 08-workflow-builder-integrations
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - src/features/integrations/linear/linear.client.ts
  - src/features/integrations/linear/linear.types.ts
  - src/features/integrations/linear/linear.sync.ts
  - src/features/integrations/linear/linear.webhooks.ts
  - src/features/integrations/linear/index.ts
  - src/shared/db/schema/linear-sync.ts
  - src/shared/db/schema/index.ts
autonomous: true

must_haves:
  truths:
    - "Tasks created in BlockBot sync to Linear as issues"
    - "Issues updated in Linear sync back to BlockBot tasks"
    - "Status, assignee, priority, and blockers map correctly between systems"
    - "Webhook endpoint receives Linear events with signature verification"
  artifacts:
    - path: "src/features/integrations/linear/linear.client.ts"
      provides: "LinearClient wrapper with typed methods"
      exports: ["createLinearClient", "createLinearIssue", "updateLinearIssue"]
    - path: "src/features/integrations/linear/linear.webhooks.ts"
      provides: "Webhook handler with signature verification"
      exports: ["linearWebhookHandler", "verifyLinearWebhook"]
    - path: "src/shared/db/schema/linear-sync.ts"
      provides: "Sync metadata schema"
      contains: "linearIssueId"
  key_links:
    - from: "src/features/integrations/linear/linear.sync.ts"
      to: "linear.client.ts"
      via: "createLinearIssue/updateLinearIssue calls"
      pattern: "createLinearIssue|updateLinearIssue"
    - from: "src/features/integrations/linear/linear.webhooks.ts"
      to: "linear.sync.ts"
      via: "syncFromLinear function"
      pattern: "syncFromLinear"
---

<objective>
Implement bidirectional Linear integration with webhooks and SDK.

Purpose: Enable teams to use both BlockBot and Linear with automatic sync (INTG-01, INTG-02, INTG-03).
Output: Linear client, bidirectional sync service, and webhook handler.
</objective>

<execution_context>
@/Users/dio/.claude/get-shit-done/workflows/execute-plan.md
@/Users/dio/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08-workflow-builder-integrations/08-CONTEXT.md
@.planning/phases/08-workflow-builder-integrations/08-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Linear client and sync schema</name>
  <files>
    - src/features/integrations/linear/linear.types.ts
    - src/features/integrations/linear/linear.client.ts
    - src/shared/db/schema/linear-sync.ts
    - src/shared/db/schema/index.ts
  </files>
  <action>
    1. Install dependency: `npm install @linear/sdk`

    2. Create `src/features/integrations/linear/linear.types.ts`:
       - Define LinearSyncMetadata interface: linearIssueId, linearTeamId, lastSyncedAt
       - Define LinearWebhookPayload interface per RESEARCH.md Pattern 4
       - Define LinearStatusMapping type for status translation
       - Define LinearConfig interface: apiKey, teamId, enabled

    3. Create `src/features/integrations/linear/linear.client.ts`:
       - Export createLinearClient(apiKey: string): LinearClient
       - Export createLinearIssue function per RESEARCH.md Pattern 5
       - Export updateLinearIssue function
       - Export getLinearIssue function for sync verification
       - Handle rate limiting gracefully (return retry-after info)

    4. Create `src/shared/db/schema/linear-sync.ts`:
       - Create linearIntegrations table: id, projectId, apiKey (encrypted), teamId, statusMappings (jsonb), enabled, createdAt, updatedAt
       - Create linearSyncMetadata table: id, taskId, linearIssueId, linearTeamId, lastSyncedAt, syncDirection
       - Add foreign key to tasks table

    5. Export from schema/index.ts
  </action>
  <verify>
    Run `cd /Users/dio/RnD && bun run typecheck` - should pass without errors.
    Verify linear.client.ts exports createLinearClient, createLinearIssue, updateLinearIssue.
  </verify>
  <done>
    LinearClient wrapper exists with typed methods.
    Schema has linearIntegrations and linearSyncMetadata tables.
    Types define webhook payloads and sync metadata.
  </done>
</task>

<task type="auto">
  <name>Task 2: Implement bidirectional sync service</name>
  <files>
    - src/features/integrations/linear/linear.sync.ts
    - src/features/integrations/linear/linear.webhooks.ts
    - src/features/integrations/linear/index.ts
  </files>
  <action>
    1. Create `src/features/integrations/linear/linear.sync.ts`:
       - Export syncTaskToLinear(task, linearClient, teamId): Creates or updates Linear issue
       - Export syncFromLinear(webhookData, projectId): Updates local task from webhook
       - Implement last-write-wins conflict resolution using timestamps
       - Map BlockBot statuses (todo, in_progress, done) to Linear states
       - Map priority (low, medium, high, urgent) to Linear priority (0-4)
       - Store linearIssueId on task after creation
       - Log all sync operations for audit trail

    2. Create `src/features/integrations/linear/linear.webhooks.ts`:
       - Export verifyLinearWebhook function using HMAC SHA256
       - Export handleLinearWebhook route handler:
         - Verify signature from x-linear-signature header
         - Parse webhook payload
         - Route to syncFromLinear for Issue type events
         - Return 200 immediately (don't block webhook)
         - Use idempotency key from webhookId to prevent duplicates

    3. Create `src/features/integrations/linear/index.ts`:
       - Export all public functions
       - Export webhook routes

    4. Add environment variables:
       - LINEAR_WEBHOOK_SECRET for webhook verification
       - LINEAR_API_KEY (optional, per-project in DB)
  </action>
  <verify>
    Run `cd /Users/dio/RnD && bun run typecheck` - should pass without errors.
    Verify sync.ts implements last-write-wins with timestamp comparison.
  </verify>
  <done>
    syncTaskToLinear creates/updates Linear issues.
    syncFromLinear handles incoming webhook changes.
    Webhook verification uses timing-safe comparison.
    Conflict resolution uses last-write-wins strategy.
  </done>
</task>

<task type="auto">
  <name>Task 3: Add Linear routes and task hooks</name>
  <files>
    - src/features/integrations/linear/linear.routes.ts
    - src/features/tasks/tasks.service.ts
    - src/index.ts
    - src/shared/lib/env.ts
  </files>
  <action>
    1. Create `src/features/integrations/linear/linear.routes.ts`:
       - POST /webhooks/linear - Webhook receiver (no auth, signature verified)
       - POST /api/v1/projects/:projectId/integrations/linear - Configure Linear integration
       - GET /api/v1/projects/:projectId/integrations/linear - Get integration status
       - POST /api/v1/tasks/:taskId/sync-linear - Manual sync trigger

    2. Update tasks.service.ts:
       - After task create: Check if project has Linear integration, call syncTaskToLinear
       - After task update: Call syncTaskToLinear if linearIssueId exists
       - Add skipLinearSync option to prevent infinite loops during webhook handling

    3. Update src/index.ts:
       - Mount Linear webhook route at /webhooks/linear
       - Mount Linear API routes under /api/v1

    4. Add to env.ts:
       - LINEAR_WEBHOOK_SECRET: z.string().optional()
  </action>
  <verify>
    Run `cd /Users/dio/RnD && bun run typecheck` - should pass without errors.
    Run `cd /Users/dio/RnD && bun run lint` - should pass without errors.
  </verify>
  <done>
    Linear webhook endpoint exists at POST /webhooks/linear.
    Task service calls Linear sync on create/update.
    Integration configuration endpoints available.
  </done>
</task>

</tasks>

<verification>
1. `cd /Users/dio/RnD && bun run typecheck` passes
2. `cd /Users/dio/RnD && bun run lint` passes
3. Linear SDK is installed in package.json
4. Webhook endpoint verifies signature before processing
5. Task create/update triggers Linear sync when integration enabled
</verification>

<success_criteria>
- Tasks sync bidirectionally between BlockBot and Linear
- Status, assignee, priority, blockers map correctly
- Webhook endpoint receives and verifies Linear events
- Last-write-wins conflict resolution works correctly
- Build and lint pass without errors
</success_criteria>

<output>
After completion, create `.planning/phases/08-workflow-builder-integrations/08-02-SUMMARY.md`
</output>
