---
phase: 08-workflow-builder-integrations
plan: 06
type: execute
wave: 1
depends_on: []
files_modified:
  - src/shared/db/schema/workflows.ts
  - src/shared/db/schema/index.ts
  - src/shared/db/migrations/*.sql
  - src/features/workflows/workflows.service.ts
  - src/features/workflows/workflows.routes.ts
  - src/features/workflows/workflows.types.ts
  - src/features/workflows/index.ts
  - src/index.ts
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "Workflow configuration persists to database"
    - "Admin can save workflow via POST /api/v1/projects/:projectId/workflows"
    - "Admin can load workflow via GET /api/v1/projects/:projectId/workflows"
  artifacts:
    - path: "src/shared/db/schema/workflows.ts"
      provides: "Workflow configuration table with JSONB nodes/edges"
      contains: "export const workflows"
    - path: "src/features/workflows/workflows.routes.ts"
      provides: "POST/GET endpoints for workflow CRUD"
      exports: ["workflowsRoutes"]
    - path: "src/features/workflows/workflows.service.ts"
      provides: "Business logic for saving/loading workflows"
      exports: ["saveWorkflow", "getWorkflow"]
  key_links:
    - from: "src/index.ts"
      to: "src/features/workflows/workflows.routes.ts"
      via: "app.route('/api/v1/projects', workflowsRoutes)"
      pattern: "app\\.route.*workflowsRoutes"
    - from: "src/features/workflows/workflows.service.ts"
      to: "src/shared/db/schema/workflows.ts"
      via: "drizzle insert/select"
      pattern: "db\\.insert|db\\.query\\.workflows"
---

<objective>
Add backend persistence for workflow configurations - database schema, API routes, and service layer.

Purpose: Close Gap 1 from verification - workflow editor UI exists but configurations don't persist
Output: Workflow configs save to database and can be loaded on page refresh
</objective>

<execution_context>
@/Users/dio/.claude/get-shit-done/workflows/execute-plan.md
@/Users/dio/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/STATE.md
@.planning/phases/08-workflow-builder-integrations/08-VERIFICATION.md
@.planning/phases/08-workflow-builder-integrations/08-01-SUMMARY.md

# Reference patterns
@src/shared/db/schema/projects.ts
@src/features/insights/insights.routes.ts
@web/src/lib/workflow/types.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create workflow database schema</name>
  <files>
    src/shared/db/schema/workflows.ts
    src/shared/db/schema/index.ts
  </files>
  <action>
Create `src/shared/db/schema/workflows.ts` with a `workflows` table:

```typescript
import { jsonb, pgTable, text, timestamp, uuid } from 'drizzle-orm/pg-core';
import { projects } from './projects';

// Store workflow nodes and edges as JSONB (flexible, matches React Flow structure)
export const workflows = pgTable('workflows', {
  id: uuid('id').primaryKey().defaultRandom(),
  projectId: uuid('project_id')
    .notNull()
    .references(() => projects.id, { onDelete: 'cascade' })
    .unique(), // One workflow per project
  name: text('name').notNull().default('Default Workflow'),
  nodes: jsonb('nodes').notNull().default([]),
  edges: jsonb('edges').notNull().default([]),
  createdAt: timestamp('created_at', { withTimezone: true }).defaultNow().notNull(),
  updatedAt: timestamp('updated_at', { withTimezone: true }).defaultNow().notNull(),
});
```

Add export to `src/shared/db/schema/index.ts`:
```typescript
export * from './workflows';
```

Run migration generation:
```bash
bun run db:generate
```
  </action>
  <verify>
- `ls src/shared/db/migrations/*.sql` shows new migration file
- `grep -l "workflows" src/shared/db/schema/index.ts` confirms export
- `bun run typecheck` passes
  </verify>
  <done>
Workflows table schema exists with projectId, nodes (JSONB), edges (JSONB), and timestamps
  </done>
</task>

<task type="auto">
  <name>Task 2: Create workflows service and routes</name>
  <files>
    src/features/workflows/workflows.types.ts
    src/features/workflows/workflows.service.ts
    src/features/workflows/workflows.routes.ts
    src/features/workflows/index.ts
    src/index.ts
  </files>
  <action>
Create the workflows feature module:

**`src/features/workflows/workflows.types.ts`:**
```typescript
import { z } from 'zod';

// Node schema matches React Flow Node structure
export const workflowNodeSchema = z.object({
  id: z.string(),
  type: z.enum(['checkIn', 'escalation', 'role', 'visibility']),
  position: z.object({
    x: z.number(),
    y: z.number(),
  }),
  data: z.record(z.unknown()),
});

// Edge schema matches React Flow Edge structure
export const workflowEdgeSchema = z.object({
  id: z.string(),
  source: z.string(),
  target: z.string(),
  type: z.string().optional(),
});

export const saveWorkflowBodySchema = z.object({
  name: z.string().optional(),
  nodes: z.array(workflowNodeSchema),
  edges: z.array(workflowEdgeSchema),
});

export type WorkflowNode = z.infer<typeof workflowNodeSchema>;
export type WorkflowEdge = z.infer<typeof workflowEdgeSchema>;
export type SaveWorkflowBody = z.infer<typeof saveWorkflowBodySchema>;
```

**`src/features/workflows/workflows.service.ts`:**
```typescript
import { eq } from 'drizzle-orm';
import { db, schema } from '../../shared/db';
import { logger } from '../../shared/lib/logger';
import type { SaveWorkflowBody, WorkflowEdge, WorkflowNode } from './workflows.types';

export interface Workflow {
  id: string;
  projectId: string;
  name: string;
  nodes: WorkflowNode[];
  edges: WorkflowEdge[];
  createdAt: Date;
  updatedAt: Date;
}

/**
 * Get workflow for a project. Returns null if no workflow exists.
 */
export async function getWorkflow(projectId: string): Promise<Workflow | null> {
  const result = await db.query.workflows.findFirst({
    where: eq(schema.workflows.projectId, projectId),
  });

  if (!result) {
    return null;
  }

  return {
    id: result.id,
    projectId: result.projectId,
    name: result.name,
    nodes: result.nodes as WorkflowNode[],
    edges: result.edges as WorkflowEdge[],
    createdAt: result.createdAt,
    updatedAt: result.updatedAt,
  };
}

/**
 * Save (upsert) workflow for a project.
 */
export async function saveWorkflow(
  projectId: string,
  data: SaveWorkflowBody
): Promise<Workflow> {
  const now = new Date();

  const result = await db
    .insert(schema.workflows)
    .values({
      projectId,
      name: data.name ?? 'Default Workflow',
      nodes: data.nodes,
      edges: data.edges,
      createdAt: now,
      updatedAt: now,
    })
    .onConflictDoUpdate({
      target: schema.workflows.projectId,
      set: {
        name: data.name ?? 'Default Workflow',
        nodes: data.nodes,
        edges: data.edges,
        updatedAt: now,
      },
    })
    .returning();

  const saved = result[0];
  if (!saved) {
    throw new Error('Failed to save workflow');
  }

  logger.info({ projectId, nodeCount: data.nodes.length }, 'Workflow saved');

  return {
    id: saved.id,
    projectId: saved.projectId,
    name: saved.name,
    nodes: saved.nodes as WorkflowNode[],
    edges: saved.edges as WorkflowEdge[],
    createdAt: saved.createdAt,
    updatedAt: saved.updatedAt,
  };
}
```

**`src/features/workflows/workflows.routes.ts`:**
```typescript
import { zValidator } from '@hono/zod-validator';
import { Hono } from 'hono';
import { ApiError } from '../../shared/middleware';
import { createResponse } from '../../shared/types';
import { authMiddleware } from '../auth/auth.middleware';
import { visibilityMiddleware } from '../visibility/visibility.middleware';
import { getWorkflow, saveWorkflow } from './workflows.service';
import { saveWorkflowBodySchema } from './workflows.types';

const workflows = new Hono();

// All routes require authentication and visibility
workflows.use('*', authMiddleware);
workflows.use('*', visibilityMiddleware);

/**
 * GET /projects/:projectId/workflows
 * Get workflow configuration for a project.
 */
workflows.get('/:projectId/workflows', async (c) => {
  const projectId = c.req.param('projectId');

  const workflow = await getWorkflow(projectId);

  // Return empty workflow if none exists (new project)
  if (!workflow) {
    return c.json(
      createResponse({
        workflow: null,
        nodes: [],
        edges: [],
      })
    );
  }

  return c.json(
    createResponse({
      workflow: {
        id: workflow.id,
        name: workflow.name,
        createdAt: workflow.createdAt.toISOString(),
        updatedAt: workflow.updatedAt.toISOString(),
      },
      nodes: workflow.nodes,
      edges: workflow.edges,
    })
  );
});

/**
 * POST /projects/:projectId/workflows
 * Save (create or update) workflow configuration.
 * Requires admin or PM role.
 */
workflows.post(
  '/:projectId/workflows',
  zValidator('json', saveWorkflowBodySchema),
  async (c) => {
    const projectId = c.req.param('projectId');
    const body = c.req.valid('json');
    const user = c.get('user');

    // TODO: In future, check if user is admin/PM for this project
    // For now, visibility middleware ensures user can see the project

    const workflow = await saveWorkflow(projectId, body);

    return c.json(
      createResponse({
        workflow: {
          id: workflow.id,
          name: workflow.name,
          createdAt: workflow.createdAt.toISOString(),
          updatedAt: workflow.updatedAt.toISOString(),
        },
        nodes: workflow.nodes,
        edges: workflow.edges,
      }),
      201
    );
  }
);

export { workflows as workflowsRoutes };
```

**`src/features/workflows/index.ts`:**
```typescript
export { workflowsRoutes } from './workflows.routes';
export { getWorkflow, saveWorkflow } from './workflows.service';
export type { Workflow } from './workflows.service';
export * from './workflows.types';
```

**Update `src/index.ts`:** Add the workflows routes import and mount them:
- Add import: `import { workflowsRoutes } from './features/workflows';`
- Mount route near insights routes: `app.route('/api/v1/projects', workflowsRoutes);`
  </action>
  <verify>
- `bun run typecheck` passes
- `bun run lint` passes
- `grep "workflowsRoutes" src/index.ts` shows route mounted
  </verify>
  <done>
Workflows API endpoints exist at GET/POST /api/v1/projects/:projectId/workflows with service layer for CRUD
  </done>
</task>

</tasks>

<verification>
1. Database schema exists with JSONB columns for nodes and edges
2. API routes are mounted and accessible
3. Service layer uses drizzle for database operations
4. All type checks pass

```bash
bun run typecheck && bun run lint
```
</verification>

<success_criteria>
- Workflows table exists in schema with projectId, nodes (JSONB), edges (JSONB)
- GET /api/v1/projects/:projectId/workflows returns workflow or empty arrays
- POST /api/v1/projects/:projectId/workflows saves workflow configuration
- Routes mounted in main app with auth and visibility middleware
</success_criteria>

<output>
After completion, create `.planning/phases/08-workflow-builder-integrations/08-06-SUMMARY.md`
</output>
