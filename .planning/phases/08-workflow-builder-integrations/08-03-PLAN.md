---
phase: 08-workflow-builder-integrations
plan: 03
type: execute
wave: 2
depends_on: [08-02]
files_modified:
  - src/features/insights/insights.types.ts
  - src/features/insights/insights.service.ts
  - src/features/insights/insights.routes.ts
  - src/features/insights/index.ts
  - src/features/messaging/messaging.proactive.ts
autonomous: true

must_haves:
  truths:
    - "Agent generates insights about output trends (e.g., 'Instagram output dropped 30%')"
    - "Agent provides proactive suggestions based on patterns"
    - "Insights are role-scoped (admin sees all, squad lead sees squad, member sees personal)"
    - "Suggestions are delivered via messaging channels"
  artifacts:
    - path: "src/features/insights/insights.service.ts"
      provides: "Insight generation with LLM analysis"
      exports: ["generateInsights", "generateSuggestions"]
    - path: "src/features/insights/insights.routes.ts"
      provides: "Insights API endpoints"
      exports: ["insightsRoutes"]
  key_links:
    - from: "src/features/insights/insights.service.ts"
      to: "src/features/metrics/metrics.service.ts"
      via: "getMetrics call for data"
      pattern: "getOutputMetrics|getVelocityMetrics"
    - from: "src/features/messaging/messaging.proactive.ts"
      to: "insights.service.ts"
      via: "generateSuggestions for proactive messages"
      pattern: "generateSuggestions"
---

<objective>
Implement smart insights and proactive suggestions using LLM analysis.

Purpose: Enable agent to generate actionable insights from metrics data (AI-04, AI-05).
Output: Insights service with trend detection and suggestion generation.
</objective>

<execution_context>
@/Users/dio/.claude/get-shit-done/workflows/execute-plan.md
@/Users/dio/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08-workflow-builder-integrations/08-CONTEXT.md
@.planning/phases/08-workflow-builder-integrations/08-RESEARCH.md
@.planning/phases/04-tasks-deliverables/04-04-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create insights types and service</name>
  <files>
    - src/features/insights/insights.types.ts
    - src/features/insights/insights.service.ts
    - src/features/insights/index.ts
  </files>
  <action>
    1. Create `src/features/insights/insights.types.ts`:
       - Define InsightType = 'trend_drop' | 'trend_rise' | 'blocker_pattern' | 'deadline_risk' | 'output_leader' | 'velocity_change'
       - Define Insight interface: id, type, title, description, metric, percentChange, timeRange, scopeType, scopeId, confidence, createdAt
       - Define Suggestion interface: id, type, title, description, action, priority, targetUserId, confidence
       - Define InsightsRequest: projectId, scopeType, scopeId, timeRange

    2. Create `src/features/insights/insights.service.ts`:
       - Import getOutputMetrics, getVelocityMetrics from metrics.service
       - Implement analyzeMetricTrends(metrics, previousMetrics): Compare current vs previous period
       - Implement generateInsights(request):
         - Fetch metrics for current and previous period
         - Detect significant changes (>10% threshold)
         - For each significant change, create Insight with context
         - Use LLM to generate human-readable insight text
       - Implement generateSuggestions(projectId, userId):
         - Fetch recent insights and user's task history
         - Use LLM function calling to generate actionable suggestions
         - Return prioritized list of suggestions

    3. Create `src/features/insights/index.ts`:
       - Export all functions and types

    LLM prompt for insights should focus on:
    - Output trends (Instagram, deliverables, PRs)
    - Velocity changes (tasks completed per week)
    - Blocker patterns (recurring blockers, stuck items)
    - Resource allocation (overloaded team members)
  </action>
  <verify>
    Run `cd /Users/dio/RnD && bun run typecheck` - should pass without errors.
    Verify generateInsights and generateSuggestions are exported.
  </verify>
  <done>
    Insights types define trend, pattern, and suggestion structures.
    generateInsights analyzes metrics for significant changes.
    generateSuggestions uses LLM to create actionable recommendations.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add insights routes and integrate with messaging</name>
  <files>
    - src/features/insights/insights.routes.ts
    - src/features/messaging/messaging.proactive.ts
    - src/index.ts
  </files>
  <action>
    1. Create `src/features/insights/insights.routes.ts`:
       - GET /api/v1/projects/:projectId/insights - Get insights for project (role-scoped)
       - GET /api/v1/projects/:projectId/insights/suggestions - Get suggestions for user
       - POST /api/v1/projects/:projectId/insights/generate - Trigger insight generation (admin only)
       - Apply visibility middleware for scope filtering

    2. Update `src/features/messaging/messaging.proactive.ts`:
       - Import generateSuggestions from insights
       - In sendDailyCheckin: Include top suggestion if available
       - In sendWeeklyRecap: Include key insights for the week
       - Create new proactive message type: 'insight_alert' for significant changes
       - Schedule insight generation before proactive messages (via BullMQ job)

    3. Update src/index.ts:
       - Mount insights routes

    4. Example insight messages:
       - "Instagram output dropped 30% this week (4 posts vs 6 last week)"
       - "Velocity up 20%! Team completed 15 tasks vs 12 last week"
       - "Heads up: 3 tasks blocking Sarah have been stuck for 2+ days"
  </action>
  <verify>
    Run `cd /Users/dio/RnD && bun run typecheck` - should pass without errors.
    Run `cd /Users/dio/RnD && bun run lint` - should pass without errors.
  </verify>
  <done>
    Insights API endpoints available at /api/v1/projects/:projectId/insights.
    Daily check-ins include relevant suggestions.
    Weekly recaps include key insights.
  </done>
</task>

</tasks>

<verification>
1. `cd /Users/dio/RnD && bun run typecheck` passes
2. `cd /Users/dio/RnD && bun run lint` passes
3. GET /api/v1/projects/:projectId/insights returns role-scoped insights
4. Proactive messages include insights and suggestions
5. Insights correctly identify >10% changes in metrics
</verification>

<success_criteria>
- Agent generates insights like "Instagram output dropped 30% this week"
- Suggestions are actionable and prioritized
- Insights are scoped by role (admin/PM sees all, squad lead sees squad, member sees personal)
- Proactive messages include relevant insights and suggestions
- Build and lint pass without errors
</success_criteria>

<output>
After completion, create `.planning/phases/08-workflow-builder-integrations/08-03-SUMMARY.md`
</output>
