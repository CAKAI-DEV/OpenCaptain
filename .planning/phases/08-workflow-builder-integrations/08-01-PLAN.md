---
phase: 08-workflow-builder-integrations
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - web/src/components/workflow/workflow-canvas.tsx
  - web/src/components/workflow/workflow-sidebar.tsx
  - web/src/components/workflow/workflow-properties.tsx
  - web/src/components/workflow/nodes/check-in-node.tsx
  - web/src/components/workflow/nodes/escalation-node.tsx
  - web/src/components/workflow/nodes/role-node.tsx
  - web/src/components/workflow/nodes/visibility-node.tsx
  - web/src/lib/workflow/layout.ts
  - web/src/lib/workflow/types.ts
  - web/src/app/(dashboard)/projects/[projectId]/workflows/page.tsx
autonomous: true

must_haves:
  truths:
    - "Admin can see a visual workflow canvas with drag-and-drop support"
    - "Admin can drag blocks from sidebar palette onto canvas"
    - "Admin can click a node to edit its properties in the right panel"
    - "Nodes auto-layout in tree hierarchy using dagre"
  artifacts:
    - path: "web/src/components/workflow/workflow-canvas.tsx"
      provides: "React Flow canvas with custom node types"
      exports: ["WorkflowCanvas"]
    - path: "web/src/lib/workflow/layout.ts"
      provides: "Dagre auto-layout utility"
      exports: ["getLayoutedElements"]
  key_links:
    - from: "web/src/components/workflow/workflow-sidebar.tsx"
      to: "workflow-canvas.tsx"
      via: "onDragStart/onDrop events"
      pattern: "setNodes.*\\.\\.\\."
    - from: "web/src/components/workflow/workflow-canvas.tsx"
      to: "layout.ts"
      via: "useEffect on nodes/edges change"
      pattern: "getLayoutedElements"
---

<objective>
Implement the visual workflow editor frontend with React Flow and dagre layout.

Purpose: Enable admins to visually configure workflows using an n8n-style block editor (WEB-03, WEB-04).
Output: Workflow canvas page with drag-and-drop block placement and properties panel.
</objective>

<execution_context>
@/Users/dio/.claude/get-shit-done/workflows/execute-plan.md
@/Users/dio/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08-workflow-builder-integrations/08-CONTEXT.md
@.planning/phases/08-workflow-builder-integrations/08-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Set up React Flow canvas with custom node types</name>
  <files>
    - web/src/components/workflow/nodes/check-in-node.tsx
    - web/src/components/workflow/nodes/escalation-node.tsx
    - web/src/components/workflow/nodes/role-node.tsx
    - web/src/components/workflow/nodes/visibility-node.tsx
    - web/src/lib/workflow/types.ts
    - web/src/components/workflow/workflow-canvas.tsx
  </files>
  <action>
    1. Install dependencies: `cd web && npm install @xyflow/react @dagrejs/dagre`

    2. Create `web/src/lib/workflow/types.ts`:
       - Define WorkflowNodeType = 'checkIn' | 'escalation' | 'role' | 'visibility'
       - Define CheckInNodeData, EscalationNodeData, RoleNodeData, VisibilityNodeData interfaces
       - Each data type includes: label, configured settings for that block type

    3. Create custom node components in `web/src/components/workflow/nodes/`:
       - CheckInNode: Shows frequency, time, target squad
       - EscalationNode: Shows trigger type, steps preview
       - RoleNode: Shows role name, tier, capabilities
       - VisibilityNode: Shows visibility scope, grants
       - Each node has Handle components for top (target) and bottom (source)
       - Use shadcn Card styling, show selected state with ring-2

    4. Create `web/src/components/workflow/workflow-canvas.tsx`:
       - Define nodeTypes object OUTSIDE component (prevent re-render flicker)
       - Use ReactFlow with nodes, edges, onNodesChange, onEdgesChange
       - Include Controls and Background components
       - Add onNodeClick to select node for properties panel
       - Export WorkflowCanvas component

    CRITICAL: Define nodeTypes outside component to avoid flickering per RESEARCH.md pitfall.
  </action>
  <verify>
    Run `cd /Users/dio/RnD/web && npm run build` - should compile without errors.
    Check that nodeTypes is defined at module level, not inside component.
  </verify>
  <done>
    Four custom node components exist with proper Handle positioning.
    WorkflowCanvas renders React Flow with nodeTypes defined outside component.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add dagre auto-layout and drag-drop from sidebar</name>
  <files>
    - web/src/lib/workflow/layout.ts
    - web/src/components/workflow/workflow-sidebar.tsx
    - web/src/components/workflow/workflow-properties.tsx
    - web/src/components/workflow/workflow-canvas.tsx
  </files>
  <action>
    1. Create `web/src/lib/workflow/layout.ts`:
       - Implement getLayoutedElements function per RESEARCH.md Pattern 2
       - NODE_WIDTH = 200, NODE_HEIGHT = 80
       - Use dagre.graphlib.Graph with rankdir: 'TB' (top-bottom)
       - Return repositioned nodes and edges

    2. Create `web/src/components/workflow/workflow-sidebar.tsx`:
       - Create block palette with 4 blocks (Check-in, Escalation, Role, Visibility)
       - Each block is draggable using onPointerDown/setPointerCapture
       - Pass nodeType on drag start for canvas to use
       - Style with shadcn Card, show icon and label for each block type

    3. Create `web/src/components/workflow/workflow-properties.tsx`:
       - Accept selectedNode prop
       - Show form fields based on node type
       - For Check-in: frequency select, time input, squad select placeholder
       - For Escalation: trigger type select, steps list
       - For Role: role name, tier, capabilities checkboxes
       - For Visibility: scope select, grants list
       - Use shadcn form components

    4. Update WorkflowCanvas to:
       - Call getLayoutedElements in useEffect when nodes/edges change
       - Handle onDrop to add new nodes at drop position
       - Track selectedNodeId state, pass to properties panel
       - Use screenToFlowPosition for correct drop coordinates

    5. Create parent layout combining sidebar (left), canvas (center), properties (right)
  </action>
  <verify>
    Run `cd /Users/dio/RnD/web && npm run build` - should compile without errors.
    Verify layout.ts exports getLayoutedElements function.
  </verify>
  <done>
    Sidebar shows 4 draggable block types.
    Dropping block on canvas adds a new node at correct position.
    Clicking node shows its properties in right panel.
    Nodes auto-layout in tree hierarchy.
  </done>
</task>

<task type="auto">
  <name>Task 3: Create workflows page and integrate editor</name>
  <files>
    - web/src/app/(dashboard)/projects/[projectId]/workflows/page.tsx
    - web/src/components/common/sidebar.tsx
  </files>
  <action>
    1. Create `web/src/app/(dashboard)/projects/[projectId]/workflows/page.tsx`:
       - Server component that fetches existing workflow config (stub for now)
       - Renders WorkflowEditor client component
       - Add save button that will POST to API (stub endpoint)

    2. Create WorkflowEditor client component:
       - Uses ReactFlowProvider wrapper
       - Three-column layout: sidebar (w-64), canvas (flex-1), properties (w-80)
       - Pass nodes/edges state down to components
       - Handle save: convert nodes/edges to JSON, console.log for now

    3. Update sidebar.tsx:
       - Add "Workflows" link in project navigation
       - Use Settings/Workflow icon
       - Link to /projects/[projectId]/workflows

    4. Add @xyflow/react CSS import in layout or page:
       - Import '@xyflow/react/dist/style.css'
  </action>
  <verify>
    Run `cd /Users/dio/RnD/web && npm run build` - should compile without errors.
    Navigate to /projects/[projectId]/workflows in browser (manual check).
  </verify>
  <done>
    Workflows page renders three-column editor layout.
    Sidebar nav includes Workflows link.
    React Flow canvas displays with background grid and controls.
  </done>
</task>

</tasks>

<verification>
1. `cd /Users/dio/RnD/web && npm run build` passes without errors
2. `cd /Users/dio/RnD/web && npm run lint` passes without errors
3. WorkflowCanvas component exists and uses nodeTypes defined at module level
4. getLayoutedElements function is exported from layout.ts
5. All four node types have custom node components
</verification>

<success_criteria>
- Admin can see visual workflow canvas at /projects/[projectId]/workflows
- Admin can drag blocks from sidebar palette onto canvas
- Nodes auto-layout in tree hierarchy when added/modified
- Clicking a node shows its editable properties
- Build and lint pass without errors
</success_criteria>

<output>
After completion, create `.planning/phases/08-workflow-builder-integrations/08-01-SUMMARY.md`
</output>
