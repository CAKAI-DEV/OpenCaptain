---
phase: 08-workflow-builder-integrations
plan: 05
type: execute
wave: 2
depends_on: ['02']
files_modified:
  - src/features/integrations/github/github.app.ts
  - src/features/integrations/github/github.client.ts
  - src/features/integrations/github/github.types.ts
  - src/features/integrations/github/index.ts
  - src/features/coding-agent/coding-agent.service.ts
  - src/features/coding-agent/coding-agent.types.ts
  - src/features/coding-agent/coding-agent.routes.ts
  - src/features/coding-agent/index.ts
  - src/shared/db/schema/github-repos.ts
  - src/shared/db/schema/coding-requests.ts
autonomous: true
user_setup:
  - service: github
    why: "GitHub App for repository access and PR creation"
    env_vars:
      - name: GITHUB_APP_ID
        source: "GitHub Settings -> Developer Settings -> GitHub Apps -> App ID"
      - name: GITHUB_APP_PRIVATE_KEY
        source: "GitHub App -> Generate Private Key -> Download .pem file content"
    dashboard_config:
      - task: "Create GitHub App"
        location: "GitHub Settings -> Developer Settings -> GitHub Apps -> New GitHub App"
      - task: "Set permissions: Contents (Read & Write), Pull requests (Read & Write)"
        location: "GitHub App -> Permissions & events"
      - task: "Install App on organization/repository"
        location: "GitHub App -> Install App"

must_haves:
  truths:
    - "Lead can authorize agent to fix a minor bug"
    - "Agent spawns coding agent to create PR with fix"
    - "PR is created for review, never auto-merged"
    - "Only linked repos are accessible to coding agent"
  artifacts:
    - path: "src/features/integrations/github/github.app.ts"
      provides: "GitHub App authentication"
      exports: ["createGitHubAppClient", "getInstallationToken"]
    - path: "src/features/coding-agent/coding-agent.service.ts"
      provides: "Coding agent orchestration"
      exports: ["requestCodingFix", "getCodingRequestStatus"]
    - path: "src/shared/db/schema/github-repos.ts"
      provides: "Linked repos schema"
      contains: "linkedRepos"
  key_links:
    - from: "src/features/coding-agent/coding-agent.service.ts"
      to: "github.app.ts"
      via: "createGitHubAppClient for repo access"
      pattern: "createGitHubAppClient"
    - from: "src/features/coding-agent/coding-agent.service.ts"
      to: "github.client.ts"
      via: "createPullRequest after fix"
      pattern: "createPullRequest"
---

<objective>
Implement GitHub App integration and coding agent for automated PR creation.

Purpose: Enable leads to authorize agent to fix minor bugs with PR for review (AI-06, AI-07).
Output: GitHub App auth, coding agent service, and PR creation flow.
</objective>

<execution_context>
@/Users/dio/.claude/get-shit-done/workflows/execute-plan.md
@/Users/dio/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08-workflow-builder-integrations/08-CONTEXT.md
@.planning/phases/08-workflow-builder-integrations/08-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create GitHub App integration</name>
  <files>
    - src/features/integrations/github/github.types.ts
    - src/features/integrations/github/github.app.ts
    - src/features/integrations/github/github.client.ts
    - src/features/integrations/github/index.ts
    - src/shared/db/schema/github-repos.ts
    - src/shared/db/schema/index.ts
  </files>
  <action>
    1. Install dependencies: `npm install @octokit/rest @octokit/auth-app jose`

    2. Create `src/features/integrations/github/github.types.ts`:
       - Define GitHubAppConfig: appId, privateKey, installationId
       - Define LinkedRepo: id, projectId, owner, repo, installationId, createdAt
       - Define PullRequestResult: number, url, state, htmlUrl

    3. Create `src/features/integrations/github/github.app.ts`:
       - Export getInstallationToken(config): Generate fresh token (1hr expiry)
       - Export createGitHubAppClient(config): Returns Octokit with installation auth
       - Use @octokit/auth-app per RESEARCH.md Pattern 6
       - CRITICAL: Generate fresh token per operation, don't cache

    4. Create `src/features/integrations/github/github.client.ts`:
       - Export createPullRequest(octokit, params): Create PR per RESEARCH.md Pattern 6
       - Export createBranch(octokit, owner, repo, baseBranch, newBranch)
       - Export getFileContent(octokit, owner, repo, path, ref)
       - Export updateFile(octokit, owner, repo, path, content, message, sha, branch)

    5. Create `src/shared/db/schema/github-repos.ts`:
       - Create linkedRepos table: id, projectId, owner, repo, installationId, createdAt
       - Create codingRequests table: id, taskId, linkedRepoId, status, branchName, prNumber, prUrl, createdAt, updatedAt

    6. Add env vars to env.ts:
       - GITHUB_APP_ID: z.string().optional()
       - GITHUB_APP_PRIVATE_KEY: z.string().optional()
  </action>
  <verify>
    Run `cd /Users/dio/RnD && bun run typecheck` - should pass without errors.
    Verify createGitHubAppClient uses @octokit/auth-app.
  </verify>
  <done>
    GitHub App authentication generates installation tokens.
    Client wrapper provides typed methods for PR operations.
    Schema has linkedRepos and codingRequests tables.
  </done>
</task>

<task type="auto">
  <name>Task 2: Implement coding agent service</name>
  <files>
    - src/features/coding-agent/coding-agent.types.ts
    - src/features/coding-agent/coding-agent.service.ts
    - src/features/coding-agent/index.ts
  </files>
  <action>
    1. Create `src/features/coding-agent/coding-agent.types.ts`:
       - Define CodingRequest: id, taskId, description, status, branchName, prUrl
       - Define CodingRequestStatus: 'pending' | 'in_progress' | 'completed' | 'failed'
       - Define CodingAgentResult: success, prUrl, prNumber, error

    2. Create `src/features/coding-agent/coding-agent.service.ts`:
       - Export requestCodingFix(taskId, description, authorizedBy):
         - Validate user has lead/admin/pm role
         - Get task and linked repo
         - Create codingRequest record with status 'pending'
         - Queue BullMQ job for async processing
         - Return request ID
       - Export processCodingRequest(requestId):
         - Called by worker
         - Create new branch from main
         - Use LLM to analyze task and generate fix strategy
         - For MVP: Generate diff suggestion, don't actually edit files
         - Create PR with description of proposed changes
         - Update codingRequest with PR URL
       - Export getCodingRequestStatus(requestId):
         - Return current status and PR URL if available

    3. Worker integration:
       - Use existing BullMQ pattern from memory.worker.ts
       - Create coding-agent.worker.ts for processing requests
       - Set concurrency to 1 (one request at a time)

    CRITICAL per CONTEXT.md: PR only, never auto-merge. Human reviews all changes.
  </action>
  <verify>
    Run `cd /Users/dio/RnD && bun run typecheck` - should pass without errors.
    Verify requestCodingFix checks user role before proceeding.
  </verify>
  <done>
    requestCodingFix validates authorization and queues work.
    processCodingRequest creates branch and PR.
    Status tracking available via getCodingRequestStatus.
    All changes require PR review, no auto-merge.
  </done>
</task>

<task type="auto">
  <name>Task 3: Add coding agent routes and repo linking</name>
  <files>
    - src/features/coding-agent/coding-agent.routes.ts
    - src/features/coding-agent/coding-agent.worker.ts
    - src/index.ts
  </files>
  <action>
    1. Create `src/features/coding-agent/coding-agent.routes.ts`:
       - POST /api/v1/projects/:projectId/repos - Link GitHub repo (admin only)
         - Validate installation ID
         - Store in linkedRepos table
       - GET /api/v1/projects/:projectId/repos - List linked repos
       - DELETE /api/v1/projects/:projectId/repos/:repoId - Unlink repo
       - POST /api/v1/tasks/:taskId/fix - Request coding fix (lead/admin/pm only)
         - Validate task exists and has linked repo
         - Call requestCodingFix
       - GET /api/v1/tasks/:taskId/fix - Get coding request status

    2. Create `src/features/coding-agent/coding-agent.worker.ts`:
       - Create BullMQ worker for 'coding-agent' queue
       - Process jobs by calling processCodingRequest
       - Update status on completion/failure
       - Add error handling and retries (max 3)

    3. Update src/index.ts:
       - Mount coding agent routes
       - Initialize coding agent worker

    4. Add messaging integration:
       - When PR is created, notify the user who requested it
       - Include PR URL in notification
  </action>
  <verify>
    Run `cd /Users/dio/RnD && bun run typecheck` - should pass without errors.
    Run `cd /Users/dio/RnD && bun run lint` - should pass without errors.
  </verify>
  <done>
    Admin can link GitHub repos to projects.
    Lead can request coding fix on tasks.
    Worker processes requests and creates PRs.
    User receives notification with PR URL.
  </done>
</task>

</tasks>

<verification>
1. `cd /Users/dio/RnD && bun run typecheck` passes
2. `cd /Users/dio/RnD && bun run lint` passes
3. GitHub App packages installed in package.json
4. Role check enforced on fix request endpoint
5. PR creation includes task context in description
</verification>

<success_criteria>
- Admin can link GitHub repos to projects
- Lead/Admin/PM can authorize coding fix for a task
- Agent creates PR with proposed fix (draft mode)
- PR includes detailed description of changes
- No auto-merge - all changes require human review
- Build and lint pass without errors
</success_criteria>

<output>
After completion, create `.planning/phases/08-workflow-builder-integrations/08-05-SUMMARY.md`
</output>
